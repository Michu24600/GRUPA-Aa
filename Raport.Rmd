---
title: "Analiza Rynku Mieszkaniowego"
subtitle: "Raport analityczny "
author: "Grupa AA"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: 
      bootstrap: 5
      base_font: !expr bslib::font_google("Inter")
      primary: "#27323E" # kolor Twojego nagÅ‚Ã³wka ze zdjÄ™cia
    toc: true             
    toc_float: true        
    number_sections: false 
---

<style>
/* Styl dla nagÅ‚Ã³wka stopnia 1 (np. # 2.) */
h1 {
  font-size: 2.2em;
  font-weight: bold;
  color: #2c3e50;
  margin-top: 30px;
}

/* Styl dla nagÅ‚Ã³wka stopnia 2 (np. ## 2.2.) - TUTAJ GO ZMNIEJSZAMY */
h2 {
  font-size: 1.3em; /* Mniejszy rozmiar */
  font-weight: bold;
  color: #34495e;
  margin-top: 20px;
  border-bottom: 1px solid #eeeeee; /* Subtelna linia pod spodem */
  padding-bottom: 5px;
}

/* Opcjonalnie: automatyczne wyjustowanie caÅ‚ego tekstu w raporcie */
body {
  text-align: justify;
}
</style>

<style>
img {
  border: 2px solid #2c3e50; /* GruboÅ›Ä‡, styl i kolor ramki */
  border-radius: 5px;        /* ZaokrÄ…glone rogi */
  padding: 5px;              /* OdstÄ™p miÄ™dzy wykresem a ramkÄ… */
  margin: 10px 0;            /* OdstÄ™p od tekstu */
  box-shadow: 2px 2px 10px rgba(0,0,0,0.1); /* Subtelny cieÅ„ */
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(bslib)
```

```{r biblioteki, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8,fig.width=16}
if(!require("dplyr")) install.packages("dplyr")
library(dplyr)
if(!require("naniar")) install.packages("naniar")
library(naniar)
if(!require("VIM")) install.packages("VIM")
library(VIM)
if(!require("tidyr")) install.packages("tidyr")
library(tidyr)
if(!require("randomForest")) install.packages("randomForest")
library(randomForest)
if (!require("validate")) {install.packages("validate")}
library(validate)
if (!require("leaflet")) {install.packages("leaflet")}
library(leaflet)
if (!require("scales")) {install.packages("scales")}
library(scales)
if (!require("ggplot2")) {install.packages("ggplot2")}
library(ggplot2)
if (!require("hexbin")) {install.packages("hexbin")}
library(hexbin)
if (!require("gganimate")) {install.packages("gganimate")}
library(gganimate)
if (!require("gifski")) {install.packages("gifski")}
library(gifski) 
if (!requireNamespace("ggmap", quietly = TRUE)) { install.packages("ggmap")} 
library(ggmap)
if (!requireNamespace("shiny", quietly = TRUE)) { install.packages("shiny")}
library(shiny)
if (!requireNamespace("shinythemes", quietly = TRUE)) {install.packages("shinythemes")}
library(shinythemes)
```

# 1. WstÄ™p i Cel Projektu

**ğŸ¯ Cel Analizy**: Celem niniejszego badania jest zidentyfikowanie oraz ocena siÅ‚y oddziaÅ‚ywania kluczowych determinant cenowych na rynku nieruchomoÅ›ci mieszkalnych w Polsce. Analiza koncentruje siÄ™ na wielowymiarowym badaniu zaleÅ¼noÅ›ci miÄ™dzy cechami fizycznymi lokalu, infrastrukturÄ… otoczenia a cenÄ… transakcyjnÄ…. Projekt zakÅ‚ada *dwuetapowÄ… weryfikacjÄ™ hipotez*: w ujÄ™ciu globalnym (dla caÅ‚ego zbioru danych) oraz w ujÄ™ciu lokalnym, poprzez szczegÃ³Å‚owÄ… analizÄ™ specyfiki wybranych rynkÃ³w miejskich (np. Warszawy,GdaÅ„ska), co pozwoli na uchwycenie niuansÃ³w lokalizacyjnych wpÅ‚ywajÄ…cych na wycenÄ™.

## 1.1 O Danych

Analiza zostaÅ‚a przeprowadzona na zbiorze danych zawierajÄ…cym oferty sprzedaÅ¼y mieszkaÅ„ z czerwca 2024 roku.

Å¹rÃ³dÅ‚o danych:\*\* [<https://www.kaggle.com/datasets/krzysztofjamroz/apartment-prices-in-poland/?select=apartments_pl_2023_08.csv>]

## 1.2. ğŸ“– SÅ‚ownik Zmiennych (Data Dictionary)

PoniÅ¼sza tabela przedstawia opis zmiennych dostÄ™pnych w analizowanym zbiorze danych:

```{r data_dictionary, echo=FALSE,message=FALSE,warning=FALSE}
# Najpierw upewnij siÄ™, Å¼e masz pakiet: install.packages("kableExtra")
library(kableExtra)
library(dplyr)

# Tworzymy dane rÄ™cznie
slownik <- tibble::tribble(
  ~"Nazwa Zmiennej", ~"Opis", 
  "id", "Unikalny identyfikator ogÅ‚oszenia", 
  "city", "Miasto, w ktÃ³rym znajduje siÄ™ nieruchomoÅ›Ä‡", 
  "price", "Cena ofertowa (PLN) ", 
  "squareMeters", "Powierzchnia mieszkania w mÂ²", 
  "rooms", "Liczba pokoi", 
  "floor / floorCount", "PiÄ™tro mieszkania / Liczba piÄ™ter", 
  "buildYear", "Rok budowy budynku", 
  "type", "Rodzaj zabudowy ", 
  "ownership", "Forma wÅ‚asnoÅ›ci", 
  "lat / lon", "WspÃ³Å‚rzÄ™dne geograficzne", 
  "centreDistance", "OdlegÅ‚oÅ›Ä‡ od centrum (km)", 
  "poiCount", "Liczba punktÃ³w POI (500m)", 
  "*Distance", "OdlegÅ‚oÅ›ci do: szkÃ³Å‚, przychodni itp.", 
  "has*Parking, Balkon, Winda, Ochrona...", "Czy ma dane udogodnienie (TAK/NIE)", 
)

kbl(slownik, caption = "SÅ‚ownik Zmiennych (Data Dictionary)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center",
                font_size = 14) %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  column_spec(1, bold = TRUE, color = "#2980b9") 
```

# 2. PorzÄ…dkowanie i czyszczenie danych

Proces przygotowania danych do analizy zostaÅ‚ podzielony na kilka kluczowych etapÃ³w: definicjÄ™ reguÅ‚ poprawnoÅ›ci, wstÄ™pnÄ… walidacjÄ™, imputacjÄ™ brakÃ³w danych (metodami statystycznymi i uczenia maszynowego) oraz weryfikacjÄ™ koÅ„cowÄ….

## 2.1. Definicja ReguÅ‚ Walidacyjnych

Przed przystÄ…pieniem do czyszczenia zdefiniowano zestaw reguÅ‚ logicznych przy uÅ¼yciu pakietu validate. PozwoliÅ‚o to na identyfikacjÄ™ bÅ‚Ä™dÃ³w w surowym zbiorze danych.

Sprawdzono m.in.:

SpÃ³jnoÅ›Ä‡ logicznÄ…: Czy piÄ™tro mieszkania nie jest wyÅ¼sze niÅ¼ liczba piÄ™ter w budynku (Logic_Floor).

Zasady budowlane: Czy w budynkach jednopiÄ™trowych nie zadeklarowano windy (Logic_Elevator).

WiarygodnoÅ›Ä‡ cen: Czy cena mieÅ›ci siÄ™ w przedziale 100 tys. â€“ 10 mln PLN.

GeolokalizacjÄ™: Czy wspÃ³Å‚rzÄ™dne geograficzne znajdujÄ… siÄ™ w granicach Polski (Bounding Box).

KompletnoÅ›Ä‡ dystansÃ³w: Czy odlegÅ‚oÅ›ci do punktÃ³w POI sÄ… wartoÅ›ciami dodatnimi.

WstÄ™pna walidacja wykazaÅ‚a naruszenia, ktÃ³re zostaÅ‚y skorygowane w kolejnych krokach.

```{r Wykres obrazujÄ…cy naruszenia, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
if (!require("validate")) install.packages("validate")
library(validate)
if(file.exists("apartments_data_2024_06.RData")) {
  load("apartments_data_2024_06.RData")
}
rules_apartments <- validator(
  Logic_Floor = floorCount >= floor,
  Logic_Small_Apt = if (squareMeters <= 20) rooms <= 3,
  Logic_Elevator = if (floorCount <= 1) hasElevator == "no",
  Range_Price = price >= 100000 & price <= 10000000,
  Geo_Poland_Lat = latitude >= 49.0 & latitude <= 54.9,
  Geo_Poland_Lon = longitude >= 14.1 & longitude <= 24.2,
  Limit_Area_Max = squareMeters < 300,
  Limit_Year_Max = buildYear < 2025,
  Positive_Basic = id > 0 & price > 0 & rooms > 0 & squareMeters > 0,
  Positive_Building = buildYear > 0 & floorCount > 0 & floor >= 0, 
  Positive_Geo_POI = latitude > 0 & longitude > 0 & poiCount >= 0,
  Positive_Distances = centreDistance > 0 & schoolDistance > 0 & clinicDistance > 0 & 
    postOfficeDistance > 0 & kindergartenDistance > 0 & restaurantDistance > 0 & 
    collegeDistance > 0 & pharmacyDistance > 0
)

cf_apartments <- confront(apartments_data_2024_06, rules_apartments)
wyniki <- summary(cf_apartments)
macierz_danych <- t(wyniki[ , c("fails", "nNA", "passes")])

#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# Polskie etykiety dla wykresu trzeba sprawdziÄ‡ czy majÄ… sens
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
polskie_etykiety <- c(
  "PiÄ™tro > PiÄ™tra budynku",
  "Za duÅ¼o pokoi (kawalerki)",
  "Brak windy (niski blok)",
  "Cena poza zakresem",
  "ZÅ‚a szerokoÅ›Ä‡ geogr.",
  "ZÅ‚a dÅ‚ugoÅ›Ä‡ geogr.",
  "MetraÅ¼ > 300m",
  "Rok budowy > 2025",
  "Ujemne wartoÅ›ci (podst.)",
  "BÅ‚Ä™dy budynku (rok/piÄ™tra)",
  "BÅ‚Ä™dy Geo/POI",
  "Ujemne dystanse"
)
layout(matrix(c(1, 2), nrow = 2), heights = c(8, 1))

par(mar = c(2, 18, 4, 2)) 
barplot(macierz_danych, 
        main = "Struktura jakoÅ›ci danych (Walidacja)",
        names.arg = polskie_etykiety,
        horiz = TRUE,
        las = 1,
        col = c("#e74c3c", "#95a5a6", "#27ae60"), 
        border = NA
)

par(mar = c(0, 0, 0, 0))
plot.new() 
legend("center", 
       legend = c("BÅ‚Ä™dy", "Braki danych", "Poprawne"), 
       fill = c("#e74c3c", "#95a5a6", "#27ae60"), 
       bty = "n", 
       horiz = TRUE, 
       cex = 1.2 
)
```

## 2.2. Strategia Czyszczenia i Imputacji

WdroÅ¼ono wieloetapowy potok przetwarzania danych (pipeline), obejmujÄ…cy:

Wykluczenie zmiennych buildingMaterial oraz condition. Decyzja ta zostaÅ‚a podyktowana znacznym stopniem niekompletnoÅ›ci danych (brakujÄ…ce wartoÅ›ci) oraz niskÄ… jakoÅ›ciÄ… informacji ÅºrÃ³dÅ‚owych, co uniemoÅ¼liwiaÅ‚o przeprowadzenie rzetelnej analizy statystycznej w tym zakresie.

Imputacja logiczna:

Braki w liczbie piÄ™ter (floor) uzupeÅ‚niono wartoÅ›ciÄ… mediany (3) lub wartoÅ›ciÄ… floorCount, jeÅ›li byÅ‚a mniejsza niÅ¼ 3.

InformacjÄ™ o windzie (hasElevator) wywnioskowano na podstawie wysokoÅ›ci budynku (przyjÄ™to, Å¼e budynki powyÅ¼ej 4 piÄ™ter posiadajÄ… windÄ™).

Imputacja statystyczna (Dystanse): BrakujÄ…ce odlegÅ‚oÅ›ci do punktÃ³w usÅ‚ugowych (\*Distance) uzupeÅ‚niono Å›redniÄ… arytmetycznÄ… obliczonÄ… lokalnie dla kaÅ¼dego miasta.

Imputacja algorytmiczna (kNN): BrakujÄ…cy rok budowy (buildYear) uzupeÅ‚niono metodÄ… k-NajbliÅ¼szych SÄ…siadÃ³w (kNN), bazujÄ…c na podobieÅ„stwie pod wzglÄ™dem liczby punktÃ³w POI oraz odlegÅ‚oÅ›ci od centrum.

```{r cleaning_logic, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# Definicja kolumn do imputacji Å›redniÄ…
distance_cols <- c(
  "collegeDistance", "clinicDistance", "restaurantDistance", 
  "pharmacyDistance", "postOfficeDistance", "kindergartenDistance", 
  "schoolDistance"
)
distance_vars_for_knn <- c("poiCount", "centreDistance")
apartments_processed <- apartments_data_2024_06 %>%
  # 1. Wykluczenie zmiennych o niskiej jakoÅ›ci
  select(-buildingMaterial, -condition) %>%
  
  # 2. Imputacja logiczna: PiÄ™tra
  # UzupeÅ‚nienie braku medianÄ… (3) lub floorCount (jeÅ›li budynek jest niÅ¼szy)
  mutate(
    floor = if_else(is.na(floor), pmin(3, floorCount), floor)
  ) %>%
  
  # 3. Imputacja logiczna: Windy
  mutate(
    hasElevator = case_when(
      (is.na(hasElevator) | hasElevator == "") & floor > 4 ~ "yes",
      (is.na(hasElevator) | hasElevator == "") & floor <= 4 ~ "no",
      TRUE ~ hasElevator
    )
  ) %>%
  
  # 4. Imputacja statystyczna: Dystanse (Å›rednia w grupach miast)
  group_by(city) %>%
  mutate(
    across(
      .cols = all_of(distance_cols),
      .fns = ~ replace(., is.na(.), mean(., na.rm = TRUE))
    )
  ) %>%
  
  # 5. Imputacja kNN: Rok budowy (buildYear)
  group_modify(~ {
    VIM::kNN(
      .x, 
      variable = "buildYear",
      dist_var = c("poiCount", "centreDistance"), 
      k = 5,
      imp_var = FALSE
    )
  }) %>%
  ungroup() %>%
  mutate(buildYear = round(buildYear))
```

## 2.3. Zaawansowana Imputacja (Random Forest)

Do uzupeÅ‚nienia brakÃ³w w kluczowej zmiennej kategorycznej type (rodzaj zabudowy) zastosowano model uczenia maszynowego Random Forest (las losowy). Model zostaÅ‚ wytrenowany na kompletnych obserwacjach (500 drzew decyzyjnych), a nastÄ™pnie wykorzystany do predykcji typu budynku dla brakujÄ…cych rekordÃ³w, co pozwoliÅ‚o na zachowanie struktury danych lepiej niÅ¼ proste uzupeÅ‚nienie dominantÄ….

```{r random_forest, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
# -----------------------------------------------------------------------------
# Imputacja Random Forest (Type)
# -----------------------------------------------------------------------------
load("apartments_processed.RData")
is_missing_type <- is.na(apartments_processed$type)

# Trenowanie modelu
train_data <- apartments_processed[!is_missing_type, ]
train_data$type <- droplevels(train_data$type)

model_rf <- randomForest(
  type ~ ., 
  data = train_data, 
  ntree = 500,
  na.action = na.omit 
)

# Predykcja tylko dla brakujÄ…cych
predictions <- predict(model_rf, newdata = apartments_processed[is_missing_type, ])

# Wstawiamy predykcje z powrotem do gÅ‚Ã³wnego zbioru
apartments_processed$type[is_missing_type] <- predictions
```

```{r KoÅ„cowa Wersja, echo=FALSE, message=FALSE, warning=FALSE}

apartments_final <- apartments_processed %>%
  mutate(
    hasElevator = if_else(floorCount <= 1 & hasElevator == "yes", NA_character_, hasElevator)
  ) %>%
  filter(!is.na(hasElevator))
```

## 2.4. Wyniki i Weryfikacja KoÅ„cowa

Po zakoÅ„czeniu procesu czyszczenia przeprowadzono:

PonownÄ… walidacjÄ™: Sprawdzono zgodnoÅ›Ä‡ danych z reguÅ‚ami validate.

AnalizÄ™ brakÃ³w (naniar): Potwierdzono wyeliminowanie kluczowych brakÃ³w danych.

Zapis: Przetworzony zbiÃ³r danych zostaÅ‚ zapisany do pliku .RData w celu optymalizacji wydajnoÅ›ci raportu.

```{r Wykres obrazujÄ…cy naruszenia po czyszczeniu, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
if (!require("validate")) install.packages("validate")
library(validate)
if(file.exists("apartments_final.RData")) {
  load("apartments_final.RData")
}
rules_apartments <- validator(
  Logic_Floor = floorCount >= floor,
  Logic_Small_Apt = if (squareMeters <= 20) rooms <= 3,
  Logic_Elevator = if (floorCount <= 1) hasElevator == "no",
  Range_Price = price >= 100000 & price <= 10000000,
  Geo_Poland_Lat = latitude >= 49.0 & latitude <= 54.9,
  Geo_Poland_Lon = longitude >= 14.1 & longitude <= 24.2,
  Limit_Area_Max = squareMeters < 300,
  Limit_Year_Max = buildYear < 2025,
  Positive_Basic = id > 0 & price > 0 & rooms > 0 & squareMeters > 0,
  Positive_Building = buildYear > 0 & floorCount > 0 & floor >= 0, 
  Positive_Geo_POI = latitude > 0 & longitude > 0 & poiCount >= 0,
  Positive_Distances = centreDistance > 0 & schoolDistance > 0 & clinicDistance > 0 & 
    postOfficeDistance > 0 & kindergartenDistance > 0 & restaurantDistance > 0 & 
    collegeDistance > 0 & pharmacyDistance > 0
)

cf_apartments <- confront(apartments_final, rules_apartments)
wyniki <- summary(cf_apartments)
macierz_danych <- t(wyniki[ , c("fails", "nNA", "passes")])

polskie_etykiety <- c(
  "PiÄ™tro > PiÄ™tra budynku",
  "Za duÅ¼o pokoi (kawalerki)",
  "Brak windy (niski blok)",
  "Cena poza zakresem",
  "ZÅ‚a szerokoÅ›Ä‡ geogr.",
  "ZÅ‚a dÅ‚ugoÅ›Ä‡ geogr.",
  "MetraÅ¼ > 300m",
  "Rok budowy > 2025",
  "Ujemne wartoÅ›ci (podst.)",
  "BÅ‚Ä™dy budynku (rok/piÄ™tra)",
  "BÅ‚Ä™dy Geo/POI",
  "Ujemne dystanse"
)
layout(matrix(c(1, 2), nrow = 2), heights = c(8, 1))

par(mar = c(2, 18, 4, 2)) 
barplot(macierz_danych, 
        main = "Struktura jakoÅ›ci danych (Walidacja)",
        names.arg = polskie_etykiety,
        horiz = TRUE,
        las = 1,
        col = c("#e74c3c", "#95a5a6", "#27ae60"), 
        border = NA
)

par(mar = c(0, 0, 0, 0))
plot.new() 
legend("center", 
       legend = c("BÅ‚Ä™dy", "Braki danych", "Poprawne"), 
       fill = c("#e74c3c", "#95a5a6", "#27ae60"), 
       bty = "n", 
       horiz = TRUE, 
       cex = 1.2 
)
```

# 3. Analiza opisowa rynku nieruchomoÅ›ci

<div style="text-align: justify;">

RozdziaÅ‚ ten stanowi szczegÃ³Å‚owÄ… analizÄ™ zebranych danych, majÄ…cÄ… na celu zrozumienie mechanizmÃ³w rzÄ…dzÄ…cych polskim rynkiem nieruchomoÅ›ci w 2026 roku. Przeprowadzona analiza opisowa pozwala zidentyfikowaÄ‡ kluczowe trendy cenowe oraz zrozumieÄ‡, jakie czynniki techniczne i lokalizacyjne w najwiÄ™kszym stopniu ksztaÅ‚tujÄ… wartoÅ›Ä‡ ofert. DziÄ™ki wykorzystaniu miar tendencji centralnej oraz metod wizualizacji, moÅ¼liwe jest oddzielenie typowych transakcji od zjawisk o charakterze luksusowym czy marginalnym. Stanowi to fundament do dalszych, bardziej zaawansowanych wnioskÃ³w dotyczÄ…cych opÅ‚acalnoÅ›ci inwestycji w konkretnych segmentach rynku.

</div>

## 3.1 OgÃ³lna charakterystyka cen mieszkaÅ„ w Polsce

```{r RozkÅ‚ad cen mieszkaÅ„ (Histogram), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot1 <- ggplot(apartments_final, aes(x = price)) +
  geom_histogram(bins = 50, fill = "#4E84C4", color = "white", alpha = 0.8) +
  scale_x_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  labs(
    title = "RozkÅ‚ad cen mieszkaÅ„",
    subtitle = "Jak ksztaÅ‚tuje siÄ™ rozkÅ‚ad cen mieszkaÅ„ w Polsce",
    x = "Cena (PLN)",
    y = "Liczba ofert"
  ) +
  theme(plot.title = element_text(face = "bold", size = 14))

print(plot1)
```


<div style="text-align: justify;">

RozkÅ‚ad cen cechuje siÄ™ silnÄ… asymetriÄ… prawostronnÄ…, z najwiÄ™kszÄ… koncentracjÄ… ofert w przedziale od 500 000 do 850 000 PLN. Dominacja tego segmentu wyznacza rynkowy standard cenowy, podczas gdy oferty powyÅ¼ej 1,5 mln PLN stanowiÄ… nielicznÄ… grupÄ™ nieruchomoÅ›ci luksusowych. WyraÅºny brak ogÅ‚oszeÅ„ poniÅ¼ej 250 000 PLN definiuje wysoki prÃ³g wejÅ›cia na badany rynek. ObecnoÅ›Ä‡ wartoÅ›ci odstajÄ…cych, siÄ™gajÄ…cych nawet 3 mln PLN, powoduje, Å¼e Å›rednia arytmetyczna jest zawyÅ¼ona. W konsekwencji to mediana, a nie Å›rednia, najlepiej oddaje realny koszt zakupu typowego mieszkania.

</div>

```{r RozkÅ‚ad cen wzglÄ™dem liczby pokoi (Price vs Rooms - Boxplot), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot2 <- ggplot(apartments_final, aes(x = as.factor(rooms), y = price, fill = as.factor(rooms))) +
  geom_boxplot(alpha = 0.7, outlier.colour = "red", outlier.shape = 1, outlier.alpha = 0.5) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  scale_fill_brewer(palette = "Set3") + # Åadna paleta kolorÃ³w
  labs(
    title = "Cena mieszkania a liczba pokoi",
    subtitle = "RozkÅ‚ad cen",
    x = "Liczba pokoi",
    y = "Cena (PLN)",
    fill = "Liczba pokoi"
  ) +
  theme(legend.position = "none") # Ukrywamy legendÄ™, bo oÅ› X wszystko wyjaÅ›nia

print(plot2)
```


<div style="text-align: justify;">

Wykres prezentuje wyraÅºnÄ… korelacjÄ™ dodatniÄ… miÄ™dzy liczbÄ… pokoi a cenÄ… nieruchomoÅ›ci, przy czym wraz ze wzrostem metraÅ¼u obserwuje siÄ™ nie tylko wzrost mediany, ale takÅ¼e znaczÄ…ce rozszerzenie rozstÄ™pu miÄ™dzykwartylowego. Rynek mieszkaÅ„ 1- i 2-pokojowych charakteryzuje siÄ™ najwiÄ™kszÄ… stabilnoÅ›ciÄ… i koncentracjÄ… cenowÄ…, gdzie niski prÃ³g wejÅ›cia oscyluje wokÃ³Å‚ 400 000 PLN, natomiast segmenty 3- i 4-pokojowe wykazujÄ… silnÄ… asymetriÄ™ prawostronnÄ… z licznymi wartoÅ›ciami odstajÄ…cymi siÄ™gajÄ…cymi nawet 3 mln PLN. ObecnoÅ›Ä‡ tak wysokich wartoÅ›ci ekstremalnych w segmencie Å›redniej wielkoÅ›ci mieszkaÅ„ Å›wiadczy o silnie rozwiniÄ™tym rynku premium, ktÃ³ry istotnie zawyÅ¼a Å›redniÄ… arytmetycznÄ…, czyniÄ…c medianÄ™ najbezpieczniejszym wskaÅºnikiem typowej ceny transakcyjnej. W przypadku najwiÄ™kszych lokali, majÄ…cych 5 i 6 pokoi, korpusy wykresÃ³w stajÄ… siÄ™ znacznie wyÅ¼sze, co sugeruje, Å¼e w tej kategorii liczba pokoi przestaje byÄ‡ dominujÄ…cym czynnikiem cenotwÃ³rczym na rzecz standardu wykoÅ„czenia i prestiÅ¼owej lokalizacji. CaÅ‚oÅ›Ä‡ obrazuje strukturÄ™ rynkowÄ…, w ktÃ³rej ryzyko cenowe i dyspersja ofert rosnÄ… progresywnie wraz z wielkoÅ›ciÄ… nieruchomoÅ›ci, definiujÄ…c rynek o wysokim stopniu zrÃ³Å¼nicowania jakoÅ›ciowego.

</div>


```{r Typ budynku a rozkÅ‚ad cen (Violin Plot + Boxplot w Å›rodku), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot3 <- apartments_final %>%
  filter(!is.na(type)) %>% 
  # Mapowanie angielskich nazw na polskie odpowiedniki
  mutate(type = recode(type, 
                       "tenement" = "Kamienica",
                       "blockOfFlats" = "Blok mieszkalny",
                       "apartmentBuilding" = "Apartamentowiec")) %>%
  ggplot(aes(x = type, y = price, fill = type)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.15, color = "black", alpha = 0.9, outlier.shape = NA) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  scale_fill_brewer(palette = "Pastel1") + # Dodanie delikatnej palety kolorÃ³w
  labs(
    title = "Typ budynku a ceny mieszkaÅ„",
    subtitle = "PorÃ³wnanie rozkÅ‚adu cen dla rÃ³Å¼nych typÃ³w zabudowy",
    x = "Rodzaj zabudowy",
    y = "Cena (PLN)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_flip() 

print(plot3)
```


<div style="text-align: justify;">

Analiza wykresu skrzypcowego (violin plot) wskazuje na istotne rÃ³Å¼nice w strukturze cenowej w zaleÅ¼noÅ›ci od typu zabudowy, przy czym segment apartamentowcÃ³w charakteryzuje siÄ™ najwyÅ¼szÄ… medianÄ… cen oraz najbardziej rozciÄ…gniÄ™tym prawostronnym ogonem rozkÅ‚adu. W przeciwieÅ„stwie do blokÃ³w, ktÃ³re wykazujÄ… najwiÄ™kszÄ… koncentracjÄ™ ofert w wÄ™Å¼szym przedziale cenowym i relatywnie najniÅ¼szy prÃ³g wejÅ›cia, kamienice prezentujÄ… specyficzny, dwumodalny charakter rozkÅ‚adu sugerujÄ…cy podziaÅ‚ na lokale standardowe oraz nieruchomoÅ›ci zrewitalizowane o znacznie wyÅ¼szej wartoÅ›ci. NajwiÄ™kszÄ… gÄ™stoÅ›Ä‡ prawdopodobieÅ„stwa dla wszystkich typÃ³w zabudowy obserwujemy w przedziale od 600 000 do 1 100 000 PLN, jednak to apartamentowce wykazujÄ… najszerszy rozstÄ™p miÄ™dzykwartylowy, co Å›wiadczy o najwiÄ™kszym zrÃ³Å¼nicowaniu standardu w tej kategorii. WyraÅºne wydÅ‚uÅ¼enie â€szyjekâ€ wykresÃ³w w stronÄ™ wartoÅ›ci przekraczajÄ…cych 2 mln PLN, szczegÃ³lnie widoczne w przypadku kamienic i apartamentowcÃ³w, potwierdza wystÄ™powanie silnej asymetrii dodatniej i unikalnych ofert luksusowych, ktÃ³re ksztaÅ‚tujÄ… gÃ³rnÄ… granicÄ™ badanego rynku. CaÅ‚oÅ›Ä‡ zestawienia dowodzi, Å¼e o ile blokowiska stanowiÄ… najbardziej przewidywalny i jednorodny segment cenowy, o tyle inwestycja w apartamenty lub kamienice wiÄ…Å¼e siÄ™ z wiÄ™kszÄ… dyspersjÄ… kosztÃ³w i obecnoÅ›ciÄ… ofert o charakterze wybitnie prestiÅ¼owym.

</div>

```{r Interaktywna mapa punktowa cen nieruchomoÅ›ci, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
paleta <- colorNumeric(
  palette = "magma", 
  domain = apartments_final$price,
  reverse = TRUE )

mapa <- apartments_final %>%
  sample_n(min(21240, nrow(apartments_final))) %>% 
  leaflet() %>%
  addTiles() %>% 
  addCircleMarkers(
    lng = ~longitude,
    lat = ~latitude,
    radius = 6,
    color = ~paleta(price), 
    fillOpacity = 0.8,
    stroke = FALSE,
    popup = ~paste0("Cena: ", price, " PLN"),
    label = ~as.character(price)
  ) %>%
  
  addLegend(
    "bottomright", 
    pal = paleta,      # I tu znowu uÅ¼ywamy palety
    values = ~price,
    title = "Cena",
    opacity = 1
  )
mapa
```

<div style="text-align: justify;">

Mapa punktowa ofert prezentuje moÅ¼liwoÅ›Ä‡ oceny koncentracji ofert w miastach wraz z rozkÅ‚adem cen w odrÃ³Å¼nienu od innych miast, ale rÃ³wnieÅ¼ dzielnic. Mapa ukazuje rÃ³Å¼nice cenowe miÄ™dzy dzielnicami centralnymi, a obrzeÅ¼ami zwanymi dzielnicami mieszkalnymi.

</div>

```{r Wykres z bombelkami dla Å›redniej ceny w miastach przeskalowany, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
city_stats <- apartments_final %>%
  group_by(city) %>% 
  summarise(
    avg_price = mean(price, na.rm = TRUE),      # Åšrednia cena
    avg_lat   = mean(latitude, na.rm = TRUE),   # Åšrodek miasta (szerokoÅ›Ä‡)
    avg_lng   = mean(longitude, na.rm = TRUE),  # Åšrodek miasta (dÅ‚ugoÅ›Ä‡)
    offer_count = n()                           
  )

city_stats_scaled <- apartments_final %>%
  group_by(city) %>%
  summarise(
    avg_price = mean(price, na.rm = TRUE),
    avg_lat   = mean(latitude, na.rm = TRUE),
    avg_lng   = mean(longitude, na.rm = TRUE),
    offer_count = n()
  ) %>%
  mutate(
    scaled_radius = scales::rescale(sqrt(offer_count), to = c(5, 35))
  )

paleta_miasta <- colorNumeric(palette = "viridis", domain = city_stats_scaled$avg_price, reverse = TRUE)

mapa_pro <- city_stats_scaled %>%
  leaflet() %>%
  addTiles() %>%
  addCircleMarkers(
    lng = ~avg_lng,
    lat = ~avg_lat,
    radius = ~scaled_radius, 

    color = ~paleta_miasta(avg_price),
    fillOpacity = 0.8,
    stroke = FALSE,
    popup = ~paste0("<b>Miasto:</b> ", city, "<br><b>Oferty:</b> ", offer_count),
    label = ~city
  ) %>%
  addLegend("bottomright", pal = paleta_miasta, values = ~avg_price, title = "Åšrednia cena")

mapa_pro
```

<div style="text-align: justify;">

Mapa bÄ…belkowa uwidacznia drastyczne dysproporcje w Å›rednich cenach mieszkaÅ„, gdzie dominujÄ…ca wielkoÅ›Ä‡ i ciemny kolor bÄ…bla nad WarszawÄ… wyznacza ogÃ³lnokrajowy szczyt cenowy przekraczajÄ…cy 1 000 000 PLN. Wysoki poziom cenowy utrzymuje siÄ™ rÃ³wnieÅ¼ w aglomeracji krakowskiej i trÃ³jmiejskiej, podczas gdy mniejsze oÅ›rodki, takie jak Radom czy CzÄ™stochowa, reprezentowane sÄ… przez jasne punkty sygnalizujÄ…ce znacznie niÅ¼szy koszt zakupu nieruchomoÅ›ci. RozkÅ‚ad ten potwierdza, Å¼e kapitaÅ‚ jest silnie skoncentrowany w kilku kluczowych metropoliach, co tworzy wyraÅºny podziaÅ‚ na drogie rynki regionalne i bardziej przystÄ™pne cenowo obszary reszty kraju.

</div>

```{r Wykres sÅ‚upkowy Å›redniej ceny za mÂ² w miastach, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
apartments_final %>%
  # 1. Obliczamy cenÄ™ za metr (jeÅ›li nie ma) i grupujemy
  mutate(price_per_sqm = price / squareMeters) %>%
  group_by(city) %>%
  summarise(mean_price_sqm = mean(price_per_sqm, na.rm = TRUE)) %>%
  
  # 2. Rysujemy
  # reorder() sortuje miasta od najtaÅ„szego do najdroÅ¼szego - kluczowe dla czytelnoÅ›ci
  ggplot(aes(x = reorder(city, mean_price_sqm), y = mean_price_sqm)) +
  
  # geom_col() to funkcja do sÅ‚upkÃ³w, gdy mamy wyliczone wartoÅ›ci
  geom_col(fill = "steelblue") + 
  
  # Obracamy wykres, Å¼eby nazwy miast siÄ™ czytaÅ‚o normalnie
  coord_flip() +
  
  # Opisy i formatowanie
  labs(
    title = "Åšrednia cena za mÂ² w miastach",
    x = "Miasto",
    y = "Cena za mÂ² (PLN)"
  ) +
  theme_minimal()
```

<div style="text-align: justify;">

Wykres sÅ‚upkowy prezentuje wyraÅºnÄ… hierarchiÄ™ cenowÄ… polskich miast, w ktÃ³rej Warszawa deklasuje pozostaÅ‚e oÅ›rodki z rekordowÄ… Å›redniÄ… stawkÄ… przekraczajÄ…cÄ… 18 000 PLN za mÂ². Drugi segment rynku tworzÄ… KrakÃ³w oraz GdaÅ„sk, gdzie ceny oscylujÄ… w granicach 15 000 â€“ 17 000 PLN, podczas gdy na przeciwlegÅ‚ym biegunie znajdujÄ… siÄ™ Radom i CzÄ™stochowa z ofertami poniÅ¼ej 7 500 PLN za mÂ². Tak duÅ¼a rozpiÄ™toÅ›Ä‡ â€” siÄ™gajÄ…ca ponad 150% miÄ™dzy stolicÄ… a miastami o najniÅ¼szych stawkach â€” obrazuje gÅ‚Ä™bokie rozwarstwienie ekonomiczne kraju i koncentracjÄ™ popytu inwestycyjnego w kilku kluczowych metropoliach.

</div>

```{r Wykres zaleÅ¼noÅ›ci ceny od odlegÅ‚oÅ›ci - UjÄ™cie ogÃ³lnokrajowe, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
wykres_odleglosci_polska <- apartments_final %>%
  mutate(cena_za_m2 = price / squareMeters) %>%
  # Filtracja outlierÃ³w dla lepszej czytelnoÅ›ci trendu
  filter(cena_za_m2 < 60000, centreDistance <= 30) %>% 
  ggplot(aes(x = centreDistance, y = cena_za_m2)) +
  # ZagÄ™szczenie punktÃ³w (hexbin lub maÅ‚e punkty z duÅ¼ym alpha)
  geom_point(alpha = 0.1, color = "#2c3e50", size = 0.8) +
  # Linia trendu dla caÅ‚ej Polski
  geom_smooth(method = "gam", color = "#e74c3c", size = 1.5, se = TRUE) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  labs(
    title = "Krajowa zaleÅ¼noÅ›Ä‡ ceny od dystansu do centrum",
    subtitle = "ZbiÃ³r wszystkich ofert z uwzglÄ™dnieniem linii trendu GAM",
    x = "OdlegÅ‚oÅ›Ä‡ od centrum (km)",
    y = "Cena za mÂ² (PLN)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank()
  )

print(wykres_odleglosci_polska)
```

