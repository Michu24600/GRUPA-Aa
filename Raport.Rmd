---
title: "Analiza Rynku Mieszkaniowego"
subtitle: "Raport analityczny"
author: "Kacper Ciszewski, MichaÅ‚ Dalach, Wiktor Drozdowski"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
  html_document:
    theme: 
      version: 5
      base_font: !expr bslib::font_google("Outfit")
      heading_font: !expr bslib::font_google("Montserrat")
      primary: "#2C3E50"
      secondary: "#E74C3C"
    toc: true
    toc_float: 
      collapsed: true
    smooth_scroll: true
    number_sections: false
    highlight: pygments
---

<script>
  function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-bs-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-bs-theme', newTheme);
    document.getElementById('theme-icon').innerHTML = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  }
</script>

<button onclick="toggleTheme()" style="
  position: fixed; top: 20px; right: 20px; z-index: 9999;
  background: var(--bs-primary); color: white; border: none;
  border-radius: 50%; width: 50px; height: 50px; font-size: 24px;
  cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
  transition: transform 0.2s;
" title="ZmieÅ„ motyw">
  <span id="theme-icon">ğŸŒ™</span>
</button>

<style>
/* GÅ‚Ã³wny kontener - uÅ¼ywamy zmiennych var(--bs-...), Å¼eby reagowaÅ‚ na zmianÄ™ motywu */
body {
  background-color: var(--bs-tertiary-bg); /* Szare w jasnym, ciemne w ciemnym */
  color: var(--bs-body-color);
  line-height: 1.7;
  transition: all 0.3s ease;
}

/* Karta z treÅ›ciÄ… */
.main-container {
  max-width: 1100px !important;
  background-color: var(--bs-body-bg); /* BiaÅ‚e w jasnym, czarne w ciemnym */
  padding: 40px !important;
  box-shadow: 0 0 20px rgba(0,0,0,0.05);
  margin-top: 30px;
  border-radius: 8px;
}

/* NagÅ‚Ã³wki */
h1 {
  color: var(--bs-primary); /* Kolor gÅ‚Ã³wny z motywu */
  font-weight: 800;
  border-left: 6px solid var(--bs-primary);
  padding-left: 15px;
  margin-top: 1.5em;
}

h2 {
  color: var(--bs-emphasis-color); /* Kontrastowy tekst */
  font-weight: 700;
  margin-top: 1.2em;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 1.2em;
}

/* PÅ‚ywajÄ…ce menu (TOC) */
#TOC {
  border: none;
  background-color: var(--bs-body-bg); /* Dopasowane tÅ‚o */
  opacity: 0.95;
  border-radius: 10px;
  padding: 10px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* Wykresy i obrazki */
img, .plotly, .html-widget {
  border-radius: 12px;
  transition: transform .3s;
}
img:hover {
  transform: scale(1.01);
}

/* Szare pudeÅ‚ka (Info-box) */
.info-box {
  padding: 20px;
  background-color: var(--bs-secondary-bg); /* Szare tÅ‚o systemowe */
  color: var(--bs-body-color);
  border-radius: 10px;
  border-left: 5px solid var(--bs-primary);
  margin: 20px 0;
}

/* Tabela */
.dataTables_wrapper {
  color: var(--bs-body-color);
}
</style>
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(bslib)
```

```{r biblioteki, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8,fig.width=16}
library(dplyr)
library(naniar)
library(VIM)
library(tidyr)
library(randomForest)
library(validate)
library(leaflet)
library(scales)
library(ggplot2)
library(hexbin)
library(gganimate)
library(gifski) 
library(ggmap)
library(shiny)
library(shinythemes)
```

# 1. WstÄ™p i Cel Projektu
<div class="info-box">
**ğŸ¯ Cel Analizy**: Celem niniejszego badania jest zidentyfikowanie oraz ocena siÅ‚y oddziaÅ‚ywania kluczowych determinant cenowych na rynku nieruchomoÅ›ci mieszkalnych w Polsce. Analiza koncentruje siÄ™ na wielowymiarowym badaniu zaleÅ¼noÅ›ci miÄ™dzy cechami fizycznymi lokalu, infrastrukturÄ… otoczenia a cenÄ… transakcyjnÄ…. Projekt zakÅ‚ada dwuetapowÄ… weryfikacjÄ™ hipotez: w ujÄ™ciu globalnym (dla caÅ‚ego zbioru danych) oraz w ujÄ™ciu lokalnym, poprzez szczegÃ³Å‚owÄ… analizÄ™ specyfiki wybranych rynkÃ³w miejskich (np. Warszawy,GdaÅ„ska), co pozwoli na uchwycenie niuansÃ³w lokalizacyjnych wpÅ‚ywajÄ…cych na wycenÄ™.
</div>
## 1.1 O Danych
<div class="info-box">
Analiza zostaÅ‚a przeprowadzona na zbiorze danych zawierajÄ…cym oferty sprzedaÅ¼y mieszkaÅ„ z czerwca 2024 roku.

**Å¹rÃ³dÅ‚o danych:** [<https://www.kaggle.com/datasets/krzysztofjamroz/apartment-prices-in-poland/?select=apartments_pl_2023_08.csv>] 
</div>
## 1.2. ğŸ“– SÅ‚ownik Zmiennych (Data Dictionary)
<div class="info-box">
PoniÅ¼sza tabela przedstawia opis zmiennych dostÄ™pnych w analizowanym zbiorze danych:
</div>
```{r data_dictionary, echo=FALSE,message=FALSE,warning=FALSE}
# Najpierw upewnij siÄ™, Å¼e masz pakiet: install.packages("kableExtra")
library(kableExtra)
library(dplyr)

# Tworzymy dane rÄ™cznie
slownik <- tibble::tribble(
  ~"Nazwa Zmiennej", ~"Opis", 
  "id", "Unikalny identyfikator ogÅ‚oszenia", 
  "city", "Miasto, w ktÃ³rym znajduje siÄ™ nieruchomoÅ›Ä‡", 
  "price", "Cena ofertowa (PLN) ", 
  "squareMeters", "Powierzchnia mieszkania w mÂ²", 
  "rooms", "Liczba pokoi", 
  "floor / floorCount", "PiÄ™tro mieszkania / Liczba piÄ™ter", 
  "buildYear", "Rok budowy budynku", 
  "type", "Rodzaj zabudowy ", 
  "ownership", "Forma wÅ‚asnoÅ›ci", 
  "lat / lon", "WspÃ³Å‚rzÄ™dne geograficzne", 
  "centreDistance", "OdlegÅ‚oÅ›Ä‡ od centrum (km)", 
  "poiCount", "Liczba punktÃ³w POI (500m)", 
  "*Distance", "OdlegÅ‚oÅ›ci do: szkÃ³Å‚, przychodni itp.", 
  "has*Parking, Balkon, Winda, Ochrona...", "Czy ma dane udogodnienie (TAK/NIE)", 
)

kbl(slownik, caption = "SÅ‚ownik Zmiennych (Data Dictionary)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center",
                font_size = 14) %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  column_spec(1, bold = TRUE, color = "#2980b9") 
```

# 2. PorzÄ…dkowanie i czyszczenie danych
<div class="info-box">
Proces przygotowania danych do analizy zostaÅ‚ podzielony na kilka kluczowych etapÃ³w: definicjÄ™ reguÅ‚ poprawnoÅ›ci, wstÄ™pnÄ… walidacjÄ™, imputacjÄ™ brakÃ³w danych (metodami statystycznymi i uczenia maszynowego) oraz weryfikacjÄ™ koÅ„cowÄ….
</div>
## 2.1. Definicja ReguÅ‚ Walidacyjnych
<div class="info-box">
Przed przystÄ…pieniem do czyszczenia zdefiniowano zestaw reguÅ‚ logicznych przy uÅ¼yciu pakietu validate. PozwoliÅ‚o to na identyfikacjÄ™ bÅ‚Ä™dÃ³w w surowym zbiorze danych.

Sprawdzono m.in.:

SpÃ³jnoÅ›Ä‡ logicznÄ…: Czy piÄ™tro mieszkania nie jest wyÅ¼sze niÅ¼ liczba piÄ™ter w budynku (Logic_Floor).

Zasady budowlane: Czy w budynkach jednopiÄ™trowych nie zadeklarowano windy (Logic_Elevator).

WiarygodnoÅ›Ä‡ cen: Czy cena mieÅ›ci siÄ™ w przedziale 100 tys. â€“ 10 mln PLN.

GeolokalizacjÄ™: Czy wspÃ³Å‚rzÄ™dne geograficzne znajdujÄ… siÄ™ w granicach Polski (Bounding Box).

KompletnoÅ›Ä‡ dystansÃ³w: Czy odlegÅ‚oÅ›ci do punktÃ³w POI sÄ… wartoÅ›ciami dodatnimi.

WstÄ™pna walidacja wykazaÅ‚a naruszenia, ktÃ³re zostaÅ‚y skorygowane w kolejnych krokach.
</div>
```{r Wykres obrazujÄ…cy naruszenia, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
if (!require("validate")) install.packages("validate")
library(validate)
if(file.exists("apartments_data_2024_06.RData")) {
  load("apartments_data_2024_06.RData")
}
rules_apartments <- validator(
  Logic_Floor = floorCount >= floor,
  Logic_Small_Apt = if (squareMeters <= 20) rooms <= 3,
  Logic_Elevator = if (floorCount <= 1) hasElevator == "no",
  Range_Price = price >= 100000 & price <= 10000000,
  Geo_Poland_Lat = latitude >= 49.0 & latitude <= 54.9,
  Geo_Poland_Lon = longitude >= 14.1 & longitude <= 24.2,
  Limit_Area_Max = squareMeters < 300,
  Limit_Year_Max = buildYear < 2025,
  Positive_Basic = id > 0 & price > 0 & rooms > 0 & squareMeters > 0,
  Positive_Building = buildYear > 0 & floorCount > 0 & floor >= 0, 
  Positive_Geo_POI = latitude > 0 & longitude > 0 & poiCount >= 0,
  Positive_Distances = centreDistance > 0 & schoolDistance > 0 & clinicDistance > 0 & 
    postOfficeDistance > 0 & kindergartenDistance > 0 & restaurantDistance > 0 & 
    collegeDistance > 0 & pharmacyDistance > 0
)

cf_apartments <- confront(apartments_data_2024_06, rules_apartments)
wyniki <- summary(cf_apartments)
macierz_danych <- t(wyniki[ , c("fails", "nNA", "passes")])

#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# Polskie etykiety dla wykresu trzeba sprawdziÄ‡ czy majÄ… sens
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
polskie_etykiety <- c(
  "PiÄ™tro > PiÄ™tra budynku",
  "Za duÅ¼o pokoi (kawalerki)",
  "Brak windy (niski blok)",
  "Cena poza zakresem",
  "ZÅ‚a szerokoÅ›Ä‡ geogr.",
  "ZÅ‚a dÅ‚ugoÅ›Ä‡ geogr.",
  "MetraÅ¼ > 300m",
  "Rok budowy > 2025",
  "Ujemne wartoÅ›ci (podst.)",
  "BÅ‚Ä™dy budynku (rok/piÄ™tra)",
  "BÅ‚Ä™dy Geo/POI",
  "Ujemne dystanse"
)
layout(matrix(c(1, 2), nrow = 2), heights = c(8, 1))

par(mar = c(2, 18, 4, 2)) 
barplot(macierz_danych, 
        main = "Struktura jakoÅ›ci danych (Walidacja)",
        names.arg = polskie_etykiety,
        horiz = TRUE,
        las = 1,
        col = c("#e74c3c", "#95a5a6", "#27ae60"), 
        border = NA
)

par(mar = c(0, 0, 0, 0))
plot.new() 
legend("center", 
       legend = c("BÅ‚Ä™dy", "Braki danych", "Poprawne"), 
       fill = c("#e74c3c", "#95a5a6", "#27ae60"), 
       bty = "n", 
       horiz = TRUE, 
       cex = 1.2 
)
```

## 2.2. Strategia Czyszczenia i Imputacji
<div class="info-box">
WdroÅ¼ono wieloetapowy potok przetwarzania danych (pipeline), obejmujÄ…cy:

Wykluczenie zmiennych buildingMaterial oraz condition. Decyzja ta zostaÅ‚a podyktowana znacznym stopniem niekompletnoÅ›ci danych (brakujÄ…ce wartoÅ›ci) oraz niskÄ… jakoÅ›ciÄ… informacji ÅºrÃ³dÅ‚owych, co uniemoÅ¼liwiaÅ‚o przeprowadzenie rzetelnej analizy statystycznej w tym zakresie.

Imputacja logiczna:

Braki w liczbie piÄ™ter (floor) uzupeÅ‚niono wartoÅ›ciÄ… mediany (3) lub wartoÅ›ciÄ… floorCount, jeÅ›li byÅ‚a mniejsza niÅ¼ 3.

InformacjÄ™ o windzie (hasElevator) wywnioskowano na podstawie wysokoÅ›ci budynku (przyjÄ™to, Å¼e budynki powyÅ¼ej 4 piÄ™ter posiadajÄ… windÄ™).

Imputacja statystyczna (Dystanse): BrakujÄ…ce odlegÅ‚oÅ›ci do punktÃ³w usÅ‚ugowych (\*Distance) uzupeÅ‚niono Å›redniÄ… arytmetycznÄ… obliczonÄ… lokalnie dla kaÅ¼dego miasta.

Imputacja algorytmiczna (kNN): BrakujÄ…cy rok budowy (buildYear) uzupeÅ‚niono metodÄ… k-NajbliÅ¼szych SÄ…siadÃ³w (kNN), bazujÄ…c na podobieÅ„stwie pod wzglÄ™dem liczby punktÃ³w POI oraz odlegÅ‚oÅ›ci od centrum.
</div>
```{r cleaning_logic, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# Definicja kolumn do imputacji Å›redniÄ…
distance_cols <- c(
  "collegeDistance", "clinicDistance", "restaurantDistance", 
  "pharmacyDistance", "postOfficeDistance", "kindergartenDistance", 
  "schoolDistance"
)
distance_vars_for_knn <- c("poiCount", "centreDistance")
apartments_processed <- apartments_data_2024_06 %>%
  # 1. Wykluczenie zmiennych o niskiej jakoÅ›ci
  select(-buildingMaterial, -condition) %>%
  
  # 2. Imputacja logiczna: PiÄ™tra
  # UzupeÅ‚nienie braku medianÄ… (3) lub floorCount (jeÅ›li budynek jest niÅ¼szy)
  mutate(
    floor = if_else(is.na(floor), pmin(3, floorCount), floor)
  ) %>%
  
  # 3. Imputacja logiczna: Windy
  mutate(
    hasElevator = case_when(
      (is.na(hasElevator) | hasElevator == "") & floor > 4 ~ "yes",
      (is.na(hasElevator) | hasElevator == "") & floor <= 4 ~ "no",
      TRUE ~ hasElevator
    )
  ) %>%
  
  # 4. Imputacja statystyczna: Dystanse (Å›rednia w grupach miast)
  group_by(city) %>%
  mutate(
    across(
      .cols = all_of(distance_cols),
      .fns = ~ replace(., is.na(.), mean(., na.rm = TRUE))
    )
  ) %>%
  
  # 5. Imputacja kNN: Rok budowy (buildYear)
  group_modify(~ {
    VIM::kNN(
      .x, 
      variable = "buildYear",
      dist_var = c("poiCount", "centreDistance"), 
      k = 5,
      imp_var = FALSE
    )
  }) %>%
  ungroup() %>%
  mutate(buildYear = round(buildYear))
```

## 2.3. Zaawansowana Imputacja (Random Forest)
<div class="info-box">
Do uzupeÅ‚nienia brakÃ³w w kluczowej zmiennej kategorycznej type (rodzaj zabudowy) zastosowano model uczenia maszynowego Random Forest (las losowy). Model zostaÅ‚ wytrenowany na kompletnych obserwacjach (500 drzew decyzyjnych), a nastÄ™pnie wykorzystany do predykcji typu budynku dla brakujÄ…cych rekordÃ³w, co pozwoliÅ‚o na zachowanie struktury danych lepiej niÅ¼ proste uzupeÅ‚nienie dominantÄ….
</div>
```{r random_forest, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
# -----------------------------------------------------------------------------
# Imputacja Random Forest (Type)
# -----------------------------------------------------------------------------
load("apartments_processed.RData")
is_missing_type <- is.na(apartments_processed$type)

# Trenowanie modelu
train_data <- apartments_processed[!is_missing_type, ]
train_data$type <- droplevels(train_data$type)

model_rf <- randomForest(
  type ~ ., 
  data = train_data, 
  ntree = 500,
  na.action = na.omit 
)

# Predykcja tylko dla brakujÄ…cych
predictions <- predict(model_rf, newdata = apartments_processed[is_missing_type, ])

# Wstawiamy predykcje z powrotem do gÅ‚Ã³wnego zbioru
apartments_processed$type[is_missing_type] <- predictions
```

```{r KoÅ„cowa Wersja, echo=FALSE, message=FALSE, warning=FALSE}

apartments_final <- apartments_processed %>%
  mutate(
    hasElevator = if_else(floorCount <= 1 & hasElevator == "yes", NA_character_, hasElevator)
  ) %>%
  filter(!is.na(hasElevator))
```

## 2.4. Wyniki i Weryfikacja KoÅ„cowa
<div class="info-box">
Po zakoÅ„czeniu procesu czyszczenia przeprowadzono:

PonownÄ… walidacjÄ™: Sprawdzono zgodnoÅ›Ä‡ danych z reguÅ‚ami validate.

AnalizÄ™ brakÃ³w (naniar): Potwierdzono wyeliminowanie kluczowych brakÃ³w danych.

Zapis: Przetworzony zbiÃ³r danych zostaÅ‚ zapisany do pliku .RData w celu optymalizacji wydajnoÅ›ci raportu.
</div>
```{r Wykres obrazujÄ…cy naruszenia po czyszczeniu, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
if (!require("validate")) install.packages("validate")
library(validate)
if(file.exists("apartments_final.RData")) {
  load("apartments_final.RData")
}
rules_apartments <- validator(
  Logic_Floor = floorCount >= floor,
  Logic_Small_Apt = if (squareMeters <= 20) rooms <= 3,
  Logic_Elevator = if (floorCount <= 1) hasElevator == "no",
  Range_Price = price >= 100000 & price <= 10000000,
  Geo_Poland_Lat = latitude >= 49.0 & latitude <= 54.9,
  Geo_Poland_Lon = longitude >= 14.1 & longitude <= 24.2,
  Limit_Area_Max = squareMeters < 300,
  Limit_Year_Max = buildYear < 2025,
  Positive_Basic = id > 0 & price > 0 & rooms > 0 & squareMeters > 0,
  Positive_Building = buildYear > 0 & floorCount > 0 & floor >= 0, 
  Positive_Geo_POI = latitude > 0 & longitude > 0 & poiCount >= 0,
  Positive_Distances = centreDistance > 0 & schoolDistance > 0 & clinicDistance > 0 & 
    postOfficeDistance > 0 & kindergartenDistance > 0 & restaurantDistance > 0 & 
    collegeDistance > 0 & pharmacyDistance > 0
)

cf_apartments <- confront(apartments_final, rules_apartments)
wyniki <- summary(cf_apartments)
macierz_danych <- t(wyniki[ , c("fails", "nNA", "passes")])

polskie_etykiety <- c(
  "PiÄ™tro > PiÄ™tra budynku",
  "Za duÅ¼o pokoi (kawalerki)",
  "Brak windy (niski blok)",
  "Cena poza zakresem",
  "ZÅ‚a szerokoÅ›Ä‡ geogr.",
  "ZÅ‚a dÅ‚ugoÅ›Ä‡ geogr.",
  "MetraÅ¼ > 300m",
  "Rok budowy > 2025",
  "Ujemne wartoÅ›ci (podst.)",
  "BÅ‚Ä™dy budynku (rok/piÄ™tra)",
  "BÅ‚Ä™dy Geo/POI",
  "Ujemne dystanse"
)
layout(matrix(c(1, 2), nrow = 2), heights = c(8, 1))

par(mar = c(2, 18, 4, 2)) 
barplot(macierz_danych, 
        main = "Struktura jakoÅ›ci danych (Walidacja)",
        names.arg = polskie_etykiety,
        horiz = TRUE,
        las = 1,
        col = c("#e74c3c", "#95a5a6", "#27ae60"), 
        border = NA
)

par(mar = c(0, 0, 0, 0))
plot.new() 
legend("center", 
       legend = c("BÅ‚Ä™dy", "Braki danych", "Poprawne"), 
       fill = c("#e74c3c", "#95a5a6", "#27ae60"), 
       bty = "n", 
       horiz = TRUE, 
       cex = 1.2 
)
```

# 3. Analiza opisowa rynku nieruchomoÅ›ci

<div class="info-box">

RozdziaÅ‚ ten stanowi szczegÃ³Å‚owÄ… analizÄ™ zebranych danych, majÄ…cÄ… na celu zrozumienie mechanizmÃ³w rzÄ…dzÄ…cych polskim rynkiem nieruchomoÅ›ci w 2026 roku. Przeprowadzona analiza opisowa pozwala zidentyfikowaÄ‡ kluczowe trendy cenowe oraz zrozumieÄ‡, jakie czynniki techniczne i lokalizacyjne w najwiÄ™kszym stopniu ksztaÅ‚tujÄ… wartoÅ›Ä‡ ofert. DziÄ™ki wykorzystaniu miar tendencji centralnej oraz metod wizualizacji, moÅ¼liwe jest oddzielenie typowych transakcji od zjawisk o charakterze luksusowym czy marginalnym. Stanowi to fundament do dalszych, bardziej zaawansowanych wnioskÃ³w dotyczÄ…cych opÅ‚acalnoÅ›ci inwestycji w konkretnych segmentach rynku.

</div>

## 3.1 OgÃ³lna charakterystyka cen mieszkaÅ„ w Polsce

```{r RozkÅ‚ad cen mieszkaÅ„ (Histogram), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot1 <- ggplot(apartments_final, aes(x = price)) +
  geom_histogram(bins = 50, fill = "#4E84C4", color = "white", alpha = 0.8) +
  scale_x_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  labs(
    title = "RozkÅ‚ad cen mieszkaÅ„",
    subtitle = "Jak ksztaÅ‚tuje siÄ™ rozkÅ‚ad cen mieszkaÅ„ w Polsce",
    x = "Cena (PLN)",
    y = "Liczba ofert"
  ) +
  theme(plot.title = element_text(face = "bold", size = 14))

print(plot1)
```


<div class="info-box">

RozkÅ‚ad cen cechuje siÄ™ silnÄ… asymetriÄ… prawostronnÄ…, z najwiÄ™kszÄ… koncentracjÄ… ofert w przedziale od 500 000 do 850 000 PLN. Dominacja tego segmentu wyznacza rynkowy standard cenowy, podczas gdy oferty powyÅ¼ej 1,5 mln PLN stanowiÄ… nielicznÄ… grupÄ™ nieruchomoÅ›ci luksusowych. WyraÅºny brak ogÅ‚oszeÅ„ poniÅ¼ej 250 000 PLN definiuje wysoki prÃ³g wejÅ›cia na badany rynek. ObecnoÅ›Ä‡ wartoÅ›ci odstajÄ…cych, siÄ™gajÄ…cych nawet 3 mln PLN, powoduje, Å¼e Å›rednia arytmetyczna jest zawyÅ¼ona. W konsekwencji to mediana, a nie Å›rednia, najlepiej oddaje realny koszt zakupu typowego mieszkania.

</div>

```{r RozkÅ‚ad cen wzglÄ™dem liczby pokoi (Price vs Rooms - Boxplot), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot2 <- ggplot(apartments_final, aes(x = as.factor(rooms), y = price, fill = as.factor(rooms))) +
  geom_boxplot(alpha = 0.7, outlier.colour = "red", outlier.shape = 1, outlier.alpha = 0.5) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  scale_fill_brewer(palette = "Set3") + # Åadna paleta kolorÃ³w
  labs(
    title = "Cena mieszkania a liczba pokoi",
    subtitle = "RozkÅ‚ad cen",
    x = "Liczba pokoi",
    y = "Cena (PLN)",
    fill = "Liczba pokoi"
  ) +
  theme(legend.position = "none") # Ukrywamy legendÄ™, bo oÅ› X wszystko wyjaÅ›nia

print(plot2)
```


<div class="info-box">

Wykres prezentuje wyraÅºnÄ… korelacjÄ™ dodatniÄ… miÄ™dzy liczbÄ… pokoi a cenÄ… nieruchomoÅ›ci, przy czym wraz ze wzrostem metraÅ¼u obserwuje siÄ™ nie tylko wzrost mediany, ale takÅ¼e znaczÄ…ce rozszerzenie rozstÄ™pu miÄ™dzykwartylowego. Rynek mieszkaÅ„ 1- i 2-pokojowych charakteryzuje siÄ™ najwiÄ™kszÄ… stabilnoÅ›ciÄ… i koncentracjÄ… cenowÄ…, gdzie niski prÃ³g wejÅ›cia oscyluje wokÃ³Å‚ 400 000 PLN, natomiast segmenty 3- i 4-pokojowe wykazujÄ… silnÄ… asymetriÄ™ prawostronnÄ… z licznymi wartoÅ›ciami odstajÄ…cymi siÄ™gajÄ…cymi nawet 3 mln PLN. ObecnoÅ›Ä‡ tak wysokich wartoÅ›ci ekstremalnych w segmencie Å›redniej wielkoÅ›ci mieszkaÅ„ Å›wiadczy o silnie rozwiniÄ™tym rynku premium, ktÃ³ry istotnie zawyÅ¼a Å›redniÄ… arytmetycznÄ…, czyniÄ…c medianÄ™ najbezpieczniejszym wskaÅºnikiem typowej ceny transakcyjnej. W przypadku najwiÄ™kszych lokali, majÄ…cych 5 i 6 pokoi, korpusy wykresÃ³w stajÄ… siÄ™ znacznie wyÅ¼sze, co sugeruje, Å¼e w tej kategorii liczba pokoi przestaje byÄ‡ dominujÄ…cym czynnikiem cenotwÃ³rczym na rzecz standardu wykoÅ„czenia i prestiÅ¼owej lokalizacji. CaÅ‚oÅ›Ä‡ obrazuje strukturÄ™ rynkowÄ…, w ktÃ³rej ryzyko cenowe i dyspersja ofert rosnÄ… progresywnie wraz z wielkoÅ›ciÄ… nieruchomoÅ›ci, definiujÄ…c rynek o wysokim stopniu zrÃ³Å¼nicowania jakoÅ›ciowego.

</div>


```{r Typ budynku a rozkÅ‚ad cen (Violin Plot + Boxplot w Å›rodku), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot3 <- apartments_final %>%
  filter(!is.na(type)) %>% 
  # Mapowanie angielskich nazw na polskie odpowiedniki
  mutate(type = recode(type, 
                       "tenement" = "Kamienica",
                       "blockOfFlats" = "Blok mieszkalny",
                       "apartmentBuilding" = "Apartamentowiec")) %>%
  ggplot(aes(x = type, y = price, fill = type)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.15, color = "black", alpha = 0.9, outlier.shape = NA) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  scale_fill_brewer(palette = "Pastel1") + # Dodanie delikatnej palety kolorÃ³w
  labs(
    title = "Typ budynku a ceny mieszkaÅ„",
    subtitle = "PorÃ³wnanie rozkÅ‚adu cen dla rÃ³Å¼nych typÃ³w zabudowy",
    x = "Rodzaj zabudowy",
    y = "Cena (PLN)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_flip() 

print(plot3)
```


<div class="info-box">

Analiza wykresu skrzypcowego (violin plot) wskazuje na istotne rÃ³Å¼nice w strukturze cenowej w zaleÅ¼noÅ›ci od typu zabudowy, przy czym segment apartamentowcÃ³w charakteryzuje siÄ™ najwyÅ¼szÄ… medianÄ… cen oraz najbardziej rozciÄ…gniÄ™tym prawostronnym ogonem rozkÅ‚adu. W przeciwieÅ„stwie do blokÃ³w, ktÃ³re wykazujÄ… najwiÄ™kszÄ… koncentracjÄ™ ofert w wÄ™Å¼szym przedziale cenowym i relatywnie najniÅ¼szy prÃ³g wejÅ›cia, kamienice prezentujÄ… specyficzny, dwumodalny charakter rozkÅ‚adu sugerujÄ…cy podziaÅ‚ na lokale standardowe oraz nieruchomoÅ›ci zrewitalizowane o znacznie wyÅ¼szej wartoÅ›ci. NajwiÄ™kszÄ… gÄ™stoÅ›Ä‡ prawdopodobieÅ„stwa dla wszystkich typÃ³w zabudowy obserwujemy w przedziale od 600 000 do 1 100 000 PLN, jednak to apartamentowce wykazujÄ… najszerszy rozstÄ™p miÄ™dzykwartylowy, co Å›wiadczy o najwiÄ™kszym zrÃ³Å¼nicowaniu standardu w tej kategorii. WyraÅºne wydÅ‚uÅ¼enie â€szyjekâ€ wykresÃ³w w stronÄ™ wartoÅ›ci przekraczajÄ…cych 2 mln PLN, szczegÃ³lnie widoczne w przypadku kamienic i apartamentowcÃ³w, potwierdza wystÄ™powanie silnej asymetrii dodatniej i unikalnych ofert luksusowych, ktÃ³re ksztaÅ‚tujÄ… gÃ³rnÄ… granicÄ™ badanego rynku. CaÅ‚oÅ›Ä‡ zestawienia dowodzi, Å¼e o ile blokowiska stanowiÄ… najbardziej przewidywalny i jednorodny segment cenowy, o tyle inwestycja w apartamenty lub kamienice wiÄ…Å¼e siÄ™ z wiÄ™kszÄ… dyspersjÄ… kosztÃ³w i obecnoÅ›ciÄ… ofert o charakterze wybitnie prestiÅ¼owym.

</div>

```{r Interaktywna mapa punktowa, echo=FALSE, message=FALSE, warning=FALSE, out.width="80%", fig.align="center"}
paleta <- colorNumeric(
  palette = "magma", 
  domain = apartments_final$price,
  reverse = TRUE )

mapa<-apartments_final %>%
  sample_n(min(21240, nrow(apartments_final))) %>% 
  leaflet(height = 500) %>% # Tutaj moÅ¼esz rÄ™cznie sterowaÄ‡ wysokoÅ›ciÄ… w pikselach
  addTiles() %>% 
  # WYÅšRODKOWANIE NA POLSKÄ˜:
  setView(lng = 19.145, lat = 51.919, zoom = 6) %>% 
  addCircleMarkers(
    lng = ~longitude,
    lat = ~latitude,
    radius = 4, # ZmniejszyÅ‚em odrobinÄ™ kropki, by przy mniejszej mapie byÅ‚y czytelne
    color = ~paleta(price), 
    fillOpacity = 0.8,
    stroke = FALSE,
    popup = ~paste0("<b>Cena:</b> ", format(price, big.mark = " "), " PLN"),
    label = ~as.character(price)
  ) %>%
  addLegend(
    "bottomright", 
    pal = paleta, 
    values = ~price,
    title = "Cena",
    opacity = 1
  )
mapa
```
<style>
.leaflet {
    margin-left: auto;
    margin-right: auto;
    border: 2px solid #2c3e50; 
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
</style>

<div class="info-box">

Mapa punktowa ofert prezentuje moÅ¼liwoÅ›Ä‡ oceny koncentracji ofert w miastach wraz z rozkÅ‚adem cen w odrÃ³Å¼nienu od innych miast, ale rÃ³wnieÅ¼ dzielnic. Mapa ukazuje rÃ³Å¼nice cenowe miÄ™dzy dzielnicami centralnymi, a obrzeÅ¼ami zwanymi dzielnicami mieszkalnymi.

</div>


```{r Wykres_babelkowy_miast, echo=FALSE, message=FALSE, warning=FALSE, out.width="85%", fig.align="center"}
# Obliczamy statystyki raz
city_stats_scaled <- apartments_final %>%
  group_by(city) %>%
  summarise(
    avg_price = mean(price, na.rm = TRUE),
    avg_lat   = mean(latitude, na.rm = TRUE),
    avg_lng   = mean(longitude, na.rm = TRUE),
    offer_count = n(),
    .groups = "drop"
  ) %>%
  mutate(
    scaled_radius = scales::rescale(sqrt(offer_count), to = c(5, 35))
  )

# Definicja palety
paleta_miasta <- colorNumeric(
  palette = "viridis", 
  domain = city_stats_scaled$avg_price, 
  reverse = TRUE
)

# Renderowanie mapy - poprawione
city_stats_scaled %>%
  leaflet(height = 500) %>%
  addTiles() %>%
  setView(lng = 19.145, lat = 51.919, zoom = 6) %>% 
  addCircleMarkers(
    lng = ~avg_lng,
    lat = ~avg_lat,
    radius = ~scaled_radius, 
    fillColor = ~paleta_miasta(avg_price), # To wypeÅ‚nia Å›rodek
    fillOpacity = 0.7,
    stroke = TRUE,        # WÅ‚Ä…czamy obramowanie
    weight = 1,           # GruboÅ›Ä‡ obramowania
    color = "white",      # Kolor obramowania (to tutaj byÅ‚ bÅ‚Ä…d!)
    popup = ~paste0("<b>Miasto:</b> ", city, 
                    "<br><b>Åšrednia cena:</b> ", format(round(avg_price), big.mark = " "), " PLN",
                    "<br><b>Liczba ofert:</b> ", offer_count),
    label = ~city
  ) %>%
  addLegend(
    "bottomright", 
    pal = paleta_miasta, 
    values = ~avg_price, 
    title = "Åšrednia cena",
    labFormat = labelFormat(suffix = " PLN", big.mark = " ")
  )

```
<div class="info-box">

Mapa bÄ…belkowa uwidacznia drastyczne dysproporcje w Å›rednich cenach mieszkaÅ„, gdzie dominujÄ…ca wielkoÅ›Ä‡ i ciemny kolor bÄ…bla nad WarszawÄ… wyznacza ogÃ³lnokrajowy szczyt cenowy przekraczajÄ…cy 1 000 000 PLN. Wysoki poziom cenowy utrzymuje siÄ™ rÃ³wnieÅ¼ w aglomeracji krakowskiej i trÃ³jmiejskiej, podczas gdy mniejsze oÅ›rodki, takie jak Radom czy CzÄ™stochowa, reprezentowane sÄ… przez jasne punkty sygnalizujÄ…ce znacznie niÅ¼szy koszt zakupu nieruchomoÅ›ci. RozkÅ‚ad ten potwierdza, Å¼e kapitaÅ‚ jest silnie skoncentrowany w kilku kluczowych metropoliach, co tworzy wyraÅºny podziaÅ‚ na drogie rynki regionalne i bardziej przystÄ™pne cenowo obszary reszty kraju.

</div>

```{r Wykres sÅ‚upkowy Å›redniej ceny za mÂ² w miastach, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
apartments_final %>%
  # 1. Obliczamy cenÄ™ za metr (jeÅ›li nie ma) i grupujemy
  mutate(price_per_sqm = price / squareMeters) %>%
  group_by(city) %>%
  summarise(mean_price_sqm = mean(price_per_sqm, na.rm = TRUE)) %>%
  
  # 2. Rysujemy
  # reorder() sortuje miasta od najtaÅ„szego do najdroÅ¼szego - kluczowe dla czytelnoÅ›ci
  ggplot(aes(x = reorder(city, mean_price_sqm), y = mean_price_sqm)) +
  
  # geom_col() to funkcja do sÅ‚upkÃ³w, gdy mamy wyliczone wartoÅ›ci
  geom_col(fill = "steelblue") + 
  
  # Obracamy wykres, Å¼eby nazwy miast siÄ™ czytaÅ‚o normalnie
  coord_flip() +
  
  # Opisy i formatowanie
  labs(
    title = "Åšrednia cena za mÂ² w miastach",
    x = "Miasto",
    y = "Cena za mÂ² (PLN)"
  ) +
  theme_minimal()
```

<div class="info-box">

Wykres sÅ‚upkowy prezentuje wyraÅºnÄ… hierarchiÄ™ cenowÄ… polskich miast, w ktÃ³rej Warszawa deklasuje pozostaÅ‚e oÅ›rodki z rekordowÄ… Å›redniÄ… stawkÄ… przekraczajÄ…cÄ… 18 000 PLN za mÂ². Drugi segment rynku tworzÄ… KrakÃ³w oraz GdaÅ„sk, gdzie ceny oscylujÄ… w granicach 15 000 â€“ 17 000 PLN, podczas gdy na przeciwlegÅ‚ym biegunie znajdujÄ… siÄ™ Radom i CzÄ™stochowa z ofertami poniÅ¼ej 7 500 PLN za mÂ². Tak duÅ¼a rozpiÄ™toÅ›Ä‡ â€” siÄ™gajÄ…ca ponad 150% miÄ™dzy stolicÄ… a miastami o najniÅ¼szych stawkach â€” obrazuje gÅ‚Ä™bokie rozwarstwienie ekonomiczne kraju i koncentracjÄ™ popytu inwestycyjnego w kilku kluczowych metropoliach.

</div>

```{r Wykres zaleÅ¼noÅ›ci ceny od odlegÅ‚oÅ›ci - UjÄ™cie ogÃ³lnokrajowe, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
wykres_odleglosci_polska <- apartments_final %>%
  mutate(cena_za_m2 = price / squareMeters) %>%
  # Filtracja outlierÃ³w dla lepszej czytelnoÅ›ci trendu
  filter(cena_za_m2 < 60000, centreDistance <= 30) %>% 
  ggplot(aes(x = centreDistance, y = cena_za_m2)) +
  # ZagÄ™szczenie punktÃ³w (hexbin lub maÅ‚e punkty z duÅ¼ym alpha)
  geom_point(alpha = 0.1, color = "#2c3e50", size = 0.8) +
  # Linia trendu dla caÅ‚ej Polski
  geom_smooth(method = "gam", color = "#e74c3c", size = 1.5, se = TRUE) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  labs(
    title = "Krajowa zaleÅ¼noÅ›Ä‡ ceny od dystansu do centrum",
    subtitle = "ZbiÃ³r wszystkich ofert z uwzglÄ™dnieniem linii trendu GAM",
    x = "OdlegÅ‚oÅ›Ä‡ od centrum (km)",
    y = "Cena za mÂ² (PLN)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank()
  )

print(wykres_odleglosci_polska)
```

<div class="info-box">
Wykres rozrzutu z liniÄ… trendu GAM obrazuje zÅ‚oÅ¼onÄ… zaleÅ¼noÅ›Ä‡ ceny za mÂ² od odlegÅ‚oÅ›ci lokalu od centrum, podwaÅ¼ajÄ…c prosty schemat liniowego spadku wartoÅ›ci wraz z oddalaniem siÄ™ od rdzenia miasta. ChoÄ‡ najwyÅ¼sze stawki jednostkowe, przekraczajÄ…ce 25 000 PLN, koncentrujÄ… siÄ™ w bezpoÅ›rednim sÄ…siedztwie centrum (0â€“2 km), linia trendu wykazuje charakterystyczne falowanie, z lokalnym wzrostem cen w okolicach 10. kilometra, co sugeruje wysokÄ… wycenÄ™ prestiÅ¼owych dzielnic sypialnianych oraz nowoczesnych osiedli apartamentowych na obrzeÅ¼ach metropolii. Ogromna chmura punktÃ³w poniÅ¼ej 15 000 PLN, rozciÄ…gajÄ…ca siÄ™ jednostajnie wzdÅ‚uÅ¼ caÅ‚ej osi odlegÅ‚oÅ›ci, Å›wiadczy o szerokiej dostÄ™pnoÅ›ci lokali o niÅ¼szym standardzie niezaleÅ¼nie od lokalizacji, podczas gdy wyraÅºne zwÄ™Å¼enie rozkÅ‚adu powyÅ¼ej 15 km sygnalizuje ostateczny spadek stawek na terenach podmiejskich. W efekcie wykres dowodzi, Å¼e o ile Å›cisÅ‚e centrum generuje rekordowe ceny ofertowe, o tyle wtÃ³rne rynki lokalne i segmenty premium poza centrum skutecznie stabilizujÄ… Å›redniÄ… cenÄ™ za metr kwadratowy na poziomie okoÅ‚o 15 000 PLN dla wiÄ™kszoÅ›ci badanego obszaru.

</div>

```{r Wykres hexbin pokazujÄ…cy zaleÅ¼noÅ›Ä‡ ceny za m2 od liczby punktÃ³w POI, wygÅ‚adzony trend GAM, skala logarytmiczna, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
wykres_fajerwerki <- apartments_final %>%
  mutate(price_per_sqm = price / squareMeters) %>%
  # Filtracja ceny i uciÄ™cie pustego "ogona" POI dla lepszej czytelnoÅ›ci
  filter(price_per_sqm < 70000, poiCount <= 180) %>%  
  
  ggplot(aes(x = poiCount, y = price_per_sqm)) +
  
  geom_hex(bins = 70) +
  
  # 1. Logarytmowanie osi Y
  scale_y_log10(breaks = c(5000, 10000, 15000, 20000, 30000, 50000)) +
  
  scale_fill_viridis_c(option = "plasma", name = "Liczba\nofert") +
  
  # 2. WygÅ‚adzenie linii trendu (ograniczenie liczby wÄ™zÅ‚Ã³w k=5 zapobiega "wÄ™Å¼ykowi")
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5), 
              color = "cyan", fill = "white", alpha = 0.2, size = 1.5) +
  
  labs(
    title = "WpÅ‚yw punktÃ³w usÅ‚ugowych (POI) na cenÄ™ metra kwadratowego",
    subtitle = "Skala logarytmiczna i wygÅ‚adzony trend GAM (dane do 180 POI)",
    x = "Liczba punktÃ³w POI w zasiÄ™gu (poiCount)",
    y = "Cena za mÂ² (PLN, skala log)"
  ) +
  
  theme_dark() +
  theme(
    plot.title = element_text(size = 16, face = "bold", color = "white"),
    plot.subtitle = element_text(color = "#cccccc"),
    axis.text = element_text(color = "#eeeeee"),
    axis.title = element_text(color = "white"),
    legend.background = element_rect(fill = "#333333"),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    plot.background = element_rect(fill = "#222222"), 
    panel.grid.major = element_line(color = "#444444"), 
    panel.grid.minor = element_blank()
  )

wykres_fajerwerki
```

<div class="info-box">

Wykres przedstawiajÄ…cy wpÅ‚yw liczby punktÃ³w usÅ‚ugowych (POI) na cenÄ™ metra kwadratowego wykazuje wyraÅºnÄ…, nieliniowÄ… zaleÅ¼noÅ›Ä‡ wzrostowÄ…, w ktÃ³rej bogatsza infrastruktura otoczenia bezpoÅ›rednio przekÅ‚ada siÄ™ na wyÅ¼szÄ… wycenÄ™ nieruchomoÅ›ci. Linia trendu GAM sugeruje, Å¼e najwiÄ™kszy przyrost wartoÅ›ci nastÄ™puje w przedziale od 50 do 130 punktÃ³w usÅ‚ugowych, gdzie cena za mÂ² stabilizuje siÄ™ na poziomie powyÅ¼ej 20 000 PLN, co odzwierciedla rynkowÄ… premiÄ™ za komfort Å¼ycia w peÅ‚ni zurbanizowanych dzielnicach. NajwiÄ™ksza koncentracja ofert (Å¼Ã³Å‚te i pomaraÅ„czowe pola) wystÄ™puje przy niskiej liczbie punktÃ³w POI i cenach rzÄ™du 10 000 â€“ 15 000 PLN, natomiast spadek linii trendu powyÅ¼ej 150 punktÃ³w usÅ‚ugowych moÅ¼e sygnalizowaÄ‡ nasycenie lub specyfikÄ™ bardzo gÄ™stych centrÃ³w miast, gdzie haÅ‚as i brak prywatnoÅ›ci zaczynajÄ… ograniczaÄ‡ dalszy wzrost stawek.

</div>

```{r Heatmapa V Cramera, echo=FALSE, fig.height=16, fig.width=16, message=FALSE, warning=FALSE}
# 1. Biblioteki
library(ggplot2)
library(reshape2)
library(dplyr)

# 2. Przygotowanie danych i wybÃ³r kolumn numerycznych
data_corr <- apartments_final %>%
  # Tworzymy nowÄ… zmiennÄ…: cena za metr kwadratowy
  mutate(price_per_sqm = price / squareMeters) %>%
  # Wybieramy zmienne
  select(price_per_sqm, squareMeters, rooms, centreDistance, poiCount, buildYear) %>%
  # ZMIANA NAZW NA POLSKIE
  rename(
    "Cena za mÂ²" = price_per_sqm,
    "MetraÅ¼" = squareMeters,
    "Liczba pokoi" = rooms,
    "Dystans do centrum" = centreDistance,
    "Liczba POI" = poiCount,
    "Rok budowy" = buildYear
  ) %>%
  na.omit()

# 3. Obliczenie macierzy korelacji Pearsona
corr_matrix <- cor(data_corr, method = "pearson")

# 4. Przygotowanie do wykresu (trÃ³jkÄ…tna mapa)
corr_matrix[upper.tri(corr_matrix)] <- NA
melted_corr <- melt(corr_matrix, na.rm = TRUE)

# 5. Wizualizacja
ggplot(melted_corr, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  # Dodanie wartoÅ›ci korelacji na kafelkach
  geom_text(aes(label = round(value, 2)), size = 4, fontface = "bold") +
  # Skala kolorÃ³w: czerwony (ujemna), biaÅ‚y (zero), niebieski (dodatnia)
  scale_fill_gradient2(low = "#e74c3c", high = "#3498db", mid = "white", 
                       midpoint = 0, limit = c(-1, 1), 
                       name = "Korelacja\nPearsona") +
  theme_minimal() +
  labs(title = "Co wpÅ‚ywa na cenÄ™ za mÂ² mieszkania?",
       subtitle = "Korelacja Pearsona dla zmiennych numerycznych",
       x = NULL, y = NULL) +
  theme(
    axis.text = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank()
  ) +
  coord_fixed()
```

<div class="info-box">

Macierz korelacji Pearsona wskazuje na zrÃ³Å¼nicowany wpÅ‚yw poszczegÃ³lnych zmiennych na cenÄ™ za mÂ², przy czym najsilniejszym dodatnim czynnikiem powiÄ…zanym z wartoÅ›ciÄ… jednostkowÄ… nieruchomoÅ›ci jest liczba punktÃ³w usÅ‚ugowych (POI) w zasiÄ™gu, co potwierdza wysokÄ… rynkowÄ… wycenÄ™ infrastruktury miejskiej. Co ciekawe, metraÅ¼ oraz liczba pokoi wykazujÄ… sÅ‚abÄ… korelacjÄ™ ujemnÄ… z cenÄ… za mÂ², co sugeruje, Å¼e wraz ze wzrostem caÅ‚kowitej powierzchni mieszkania, stawka za pojedynczy metr kwadratowy ma tendencjÄ™ do lekkiego spadku. JednoczeÅ›nie obserwujemy silne, naturalne wspÃ³Å‚zaleÅ¼noÅ›ci miÄ™dzy metraÅ¼em a liczbÄ… pokoi (0.82) oraz istotnÄ… korelacjÄ™ ujemnÄ… miÄ™dzy dystansem do centrum a liczbÄ… punktÃ³w POI (-0.45), co dowodzi, Å¼e im dalej od serca miasta, tym uboÅ¼sza staje siÄ™ oferta usÅ‚ugowa, co poÅ›rednio rzutuje na finalnÄ… wycenÄ™ lokalu.

</div>
```{r Interaktywny_Dashboard_RPubs_Clean, echo=FALSE, message=FALSE, warning=FALSE}

library(crosstalk)
library(plotly)
library(dplyr)
library(htmltools)


dane_do_widgetu <- apartments_final %>%
  select(city, price, squareMeters, buildYear, centreDistance, hasElevator) %>%
  mutate(hasElevator = ifelse(hasElevator == "yes", "Tak", "Nie"))

sd <- SharedData$new(dane_do_widgetu)


bscols(
  widths = c(3, 9), # Lewa kolumna (3), Prawa kolumna (9)
  
 
  list(
    h4("ğŸ›ï¸ Filtry"),
    
    # Suwak dystansu
    filter_slider("dist", "OdlegÅ‚oÅ›Ä‡ od centrum (km)", sd, ~centreDistance, step = 0.5, width = "100%"),
    
    # Suwak metraÅ¼u
    filter_slider("sqm", "MetraÅ¼ (mÂ²)", sd, ~squareMeters, step = 1, width = "100%"),
    
    # Checkbox windy
    filter_checkbox("elevator", "Winda", sd, ~hasElevator)
  ), 
 
  
 
  list(
    plot_ly(sd, x = ~price, type = "histogram", marker = list(color = "#2c3e50")) %>%
      layout(
        title = "RozkÅ‚ad cen w wybranym segmencie",
        xaxis = list(title = "Cena (PLN)"),
        yaxis = list(title = "Liczba ofert"),
        bargap = 0.1
      )
  )
)
```
<div class="info-box">
PowyÅ¼szy moduÅ‚ umoÅ¼liwia dynamicznÄ… segmentacjÄ™ rynku. ManipulujÄ…c suwakami, moÅ¼na zaobserwowaÄ‡ zjawisko elastycznoÅ›ci cenowej: przy zmniejszaniu odlegÅ‚oÅ›ci od centrum (< 3 km), histogram wyraÅºnie przesuwa siÄ™ w prawo i spÅ‚aszcza, co potwierdza wystÄ™powanie znacznej premii lokalizacyjnej oraz wiÄ™ksze rozwarstwienie cen w prestiÅ¼owych dzielnicach.
</div>
```{r Podstawowe statystyki opisowe w podziale na miasta, echo=FALSE, fig.height=16, fig.width=16, message=FALSE, warning=FALSE}

if (!require("e1071")) install.packages("e1071")
if (!require("DT")) install.packages("DT")
library(e1071)
library(dplyr)
library(tidyr)
library(DT)


tabela_stylizowana <- apartments_final %>%
  group_by(city) %>%
  summarise(
    Min = min(price, na.rm = TRUE),
    Max = max(price, na.rm = TRUE),
    `Kwartyl dolny` = quantile(price, 0.25, na.rm = TRUE),
    Mediana = median(price, na.rm = TRUE),
    `Kwartyl gÃ³rny` = quantile(price, 0.75, na.rm = TRUE),
    Åšrednia = mean(price, na.rm = TRUE),
    `Odch. std.` = sd(price, na.rm = TRUE),
    IQR = IQR(price, na.rm = TRUE),
    `Odchylenie Ä‡wiartkowe` = IQR(price, na.rm = TRUE) / 2,
    `Odch. std. w %` = (sd(price, na.rm = TRUE) / mean(price, na.rm = TRUE)),
    `Odch. Ä‡wiartkowe w %` = (IQR(price, na.rm = TRUE) / 2) / median(price, na.rm = TRUE),
    SkoÅ›noÅ›Ä‡ = skewness(price, na.rm = TRUE),
    Kurtoza = kurtosis(price, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = -city, names_to = "Statystyka", values_to = "WartoÅ›Ä‡") %>%
  pivot_wider(names_from = city, values_from = WartoÅ›Ä‡) %>%
  mutate(across(where(is.numeric), ~ round(., 2)))


datatable(tabela_stylizowana,
          extensions = 'FixedColumns', 
          options = list(
            pageLength = 15,
            scrollX = TRUE,      
            dom = 't',
            fixedColumns = list(leftColumns = 1) # <--- KROK 2: Przypinamy 1. kolumnÄ™
          ),
          class = 'cell-border stripe',
          rownames = FALSE,
          caption = 'PorÃ³wnanie Statystyk Cenowych Miast (PrzewiÅ„ w prawo ->)')
```
<div class="info-box">
Analiza przedstawionych statystyk opisowych wskazuje na znaczÄ…ce zrÃ³Å¼nicowanie rynku w badanych miastach, gdzie Warszawa, GdaÅ„sk oraz Gdynia wyraÅºnie dominujÄ… pod wzglÄ™dem najwyÅ¼szych Å›rednich wartoÅ›ci. NajniÅ¼sze wartoÅ›ci Å›rednie oraz mediany odnotowano natomiast w Radomiu i CzÄ™stochowie, co potwierdza duÅ¼Ä… rozpiÄ™toÅ›Ä‡ cenowÄ… lub wartoÅ›ciowÄ… pomiÄ™dzy poszczegÃ³lnymi regionami. W wiÄ™kszoÅ›ci analizowanych lokalizacji wystÄ™puje dodatnia skoÅ›noÅ›Ä‡, co oznacza przewagÄ™ wynikÃ³w poniÅ¼ej Å›redniej i wystÄ™powanie wartoÅ›ci skrajnie wysokich, szczegÃ³lnie widocznych w Warszawie, gdzie maksimum siÄ™ga poziomu trzech milionÃ³w.

Pod kÄ…tem stabilnoÅ›ci danych, najwyÅ¼szy poziom rozproszenia mierzony odchyleniem standardowym oraz wspÃ³Å‚czynnikiem zmiennoÅ›ci wykazujÄ… rynki w Gdyni i GdaÅ„sku, co sugeruje mniejszÄ… przewidywalnoÅ›Ä‡ cen w tych lokalizacjach w porÃ³wnaniu do bardziej stabilnego Radomia czy Lublina. RozkÅ‚ad wartoÅ›ci w wiÄ™kszoÅ›ci miast charakteryzuje siÄ™ rÃ³wnieÅ¼ dodatniÄ… kurtozÄ…, wskazujÄ…cÄ… na relatywnie wysoki stopieÅ„ koncentracji wynikÃ³w wokÃ³Å‚ Å›redniej, przy jednoczesnym wystÄ™powaniu szerokiego rozstÄ™pu miÄ™dzykwartylowego (IQR) w najwiÄ™kszych aglomeracjach. Takie zestawienie danych sugeruje, Å¼e rynki w duÅ¼ych miastach wojewÃ³dzkich sÄ… nie tylko najdroÅ¼sze, ale rÃ³wnieÅ¼ najbardziej wewnÄ™trznie zrÃ³Å¼nicowane pod wzglÄ™dem struktury oferowanych wartoÅ›ci.
</div>

```{r Statystyki opisowe w relacji, type a cena za metr kwadratowy, echo=FALSE, fig.height=16, fig.width=16, message=FALSE, warning=FALSE}
# 1. Instalacja i Å‚adowanie niezbÄ™dnych bibliotek
if (!require("e1071")) install.packages("e1071")
if (!require("DT")) install.packages("DT")
library(e1071)
library(dplyr)
library(tidyr)
library(DT)

# 2. Przygotowanie statystyk i zmiana nazw na polskie w jednym kroku
tabela_polskie_nazwy <- apartments_final %>%
  mutate(price_per_sqm = price / squareMeters) %>%
  filter(!is.na(type)) %>%
  # Tutaj zmieniamy nazwy wartoÅ›ci w kolumnie 'type' zanim jÄ… obrÃ³cimy
  mutate(type = case_when(
    type == "apartmentBuilding" ~ "Apartamentowiec",
    type == "blockOfFlats" ~ "Blok",
    type == "tenement" ~ "Kamienica",
    TRUE ~ type
  )) %>%
  group_by(type) %>%
  summarise(
    Min = min(price_per_sqm, na.rm = TRUE),
    Max = max(price_per_sqm, na.rm = TRUE),
    `Kwartyl dolny` = quantile(price_per_sqm, 0.25, na.rm = TRUE),
    Mediana = median(price_per_sqm, na.rm = TRUE),
    `Kwartyl gÃ³rny` = quantile(price_per_sqm, 0.75, na.rm = TRUE),
    Åšrednia = mean(price_per_sqm, na.rm = TRUE),
    `Odch. std.` = sd(price_per_sqm, na.rm = TRUE),
    IQR = IQR(price_per_sqm, na.rm = TRUE),
    `Odchylenie Ä‡wiartkowe` = IQR(price_per_sqm, na.rm = TRUE) / 2,
    `Odch. std. w %` = (sd(price_per_sqm, na.rm = TRUE) / mean(price_per_sqm, na.rm = TRUE)),
    `Odch. Ä‡wiartkowe w %` = (IQR(price_per_sqm, na.rm = TRUE) / 2) / median(price_per_sqm, na.rm = TRUE),
    SkoÅ›noÅ›Ä‡ = skewness(price_per_sqm, na.rm = TRUE),
    Kurtoza = kurtosis(price_per_sqm, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # 2. Transpozycja (teraz type ma juÅ¼ polskie nazwy, wiÄ™c pivot_wider zrobi polskie kolumny)
  pivot_longer(cols = -type, names_to = "Statystyka", values_to = "WartoÅ›Ä‡") %>%
  pivot_wider(names_from = type, values_from = WartoÅ›Ä‡) %>%
  mutate(across(where(is.numeric), ~ round(., 2)))

# 3. WyÅ›wietlenie tabeli
datatable(tabela_polskie_nazwy, 
          options = list(
            pageLength = 15, 
            dom = 't',          
            scrollX = TRUE,     
            ordering = FALSE    
          ),
          class = 'cell-border stripe', 
          rownames = FALSE,
          caption = 'Statystyki opisowe ceny za mÂ² w zaleÅ¼noÅ›ci od typu zabudowy')

```

<div class="info-box">
Analiza danych wykazuje, Å¼e segment apartamentowcÃ³w charakteryzuje siÄ™ najwyÅ¼szym prestiÅ¼em cenowym, osiÄ…gajÄ…c Å›redniÄ… na poziomie 18 261,18 zÅ‚ za metr kwadratowy oraz medianÄ™ wynoszÄ…cÄ… 18 188,43. W porÃ³wnaniu do blokÃ³w i kamienic, apartamentowce cechujÄ… siÄ™ najwiÄ™kszÄ… stabilnoÅ›ciÄ… cenowÄ…, co potwierdza najniÅ¼szy wspÃ³Å‚czynnik zmiennoÅ›ci (odchylenie standardowe w % wynosi 0,27) oraz niemal symetryczny rozkÅ‚ad wartoÅ›ci. Z kolei kamienice, mimo niÅ¼szej Å›redniej ceny (14 533,8), wykazujÄ… najwiÄ™ksze zrÃ³Å¼nicowanie wewnÄ™trzne, o czym Å›wiadczy najwyÅ¼sze odchylenie standardowe oraz najwyÅ¼szy rozstÄ™p miÄ™dzykwartylowy (IQR) wynoszÄ…cy 9819,32. Wszystkie badane kategorie posiadajÄ… dodatniÄ… skoÅ›noÅ›Ä‡, co wskazuje na przewagÄ™ ofert o cenach niÅ¼szych niÅ¼ Å›rednia, przy czym najsilniejszÄ… tendencjÄ™ w tym kierunku obserwujemy w przypadku tradycyjnych blokÃ³w.
</div>
## 3.2 Analiza rÃ³Å¼nic cenowych miÄ™dzy WarszawÄ… a GdaÅ„skiem
<div class="info-box">
W niniejszym podrozdziale zestawiono dwa duÅ¼e rynki w Polsce: **stoÅ‚ecznÄ… WarszawÄ™**, bÄ™dÄ…cÄ… centrum biznesowym, oraz **GdaÅ„sk**, peÅ‚niÄ…cy rolÄ™ kluczowego oÅ›rodka turystycznego i portowego. BezpoÅ›rednia analiza porÃ³wnawcza pozwala oszacowaÄ‡ "premiÄ™ stoÅ‚ecznÄ…" oraz zweryfikowaÄ‡, w jakim stopniu segmenty cenowe obu aglomeracji siÄ™ pokrywajÄ…. Zbadanie rÃ³Å¼nic w rozkÅ‚adach cen jest kluczowe dla oceny, czy gdaÅ„ski rynek premium stanowi cenowÄ… alternatywÄ™ dla standardowych inwestycji w stolicy.
</div>
```{r warszawa_vs_gdansk, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
apartments_final %>%
  filter(city %in% c("warszawa", "gdansk")) %>%
  filter(price < 2500000) %>% # Ocinamy ekstremalne ogony dla czytelnoÅ›ci
  ggplot(aes(x = price, fill = city)) +
  geom_density(alpha = 0.6, color = NA) +
  scale_x_continuous(labels = scales::label_number(suffix = " PLN", scale = 1e-6, accuracy = 0.1, big.mark = ",")) +
  scale_fill_manual(values = c("gdansk" = "#2980b9", "warszawa" = "#c0392b")) +
  labs(
    title = "Warszawa vs GdaÅ„sk",
    subtitle = "RozkÅ‚ad gÄ™stoÅ›ci cen ofertowych (oÅ› X w mln PLN)",
    x = "Cena caÅ‚kowita (mln PLN)",
    y = "GÄ™stoÅ›Ä‡ rozkÅ‚adu",
    fill = "Miasto"
  ) +
  theme_minimal(base_family = "sans") +
  theme(
    legend.position = "top",
    plot.title = element_text(face = "bold", size = 14, color = "#2c3e50")
  )
```
<div class="info-box">
Analiza wizualna ujawnia zasadnicze rÃ³Å¼nice w strukturze obu rynkÃ³w. GdaÅ„sk charakteryzuje siÄ™ rozkÅ‚adem o wysokiej smukÅ‚oÅ›ci, co oznacza duÅ¼Ä… koncentracjÄ™ ofert w wÄ…skim przedziale cenowym miÄ™dzy szeÅ›Ä‡set a siedemset tysiÄ™cy zÅ‚otych. Rynek ten jest przez to bardziej jednorodny i przewidywalny z punktu widzenia inwestora.

W przeciwieÅ„stwie do niego Warszawa prezentuje rozkÅ‚ad spÅ‚aszczony z wyraÅºnym przesuniÄ™ciem w stronÄ™ wyÅ¼szych wartoÅ›ci, gdzie mediana oscyluje wokÃ³Å‚ oÅ›miuset piÄ™Ä‡dziesiÄ™ciu tysiÄ™cy zÅ‚otych. KluczowÄ… obserwacjÄ… w przypadku stolicy jest wystÄ™powanie szerokiego zakresu wartoÅ›ci skrajnych po prawej stronie wykresu. Wskazuje to na znaczÄ…cy udziaÅ‚ segmentu luksusowego, w ktÃ³rym oferty przekraczajÄ…ce pÃ³Å‚tora miliona zÅ‚otych stanowiÄ… istotnÄ… czÄ™Å›Ä‡ rynku, podczas gdy w GdaÅ„sku sÄ… one zjawiskiem marginalnym. Rynek stoÅ‚eczny cechuje siÄ™ zatem znacznie wiÄ™kszym zrÃ³Å¼nicowaniem cenowym.
</div>
```{r Wykres_odleglosci_WWA_GDA, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
wykres_odleglosci <- apartments_final %>%
  mutate(price_per_sqm = price / squareMeters) %>%
  
  # --- TUTAJ JEST ZMIANA ---
  # Zostawiamy tylko te dwa miasta:
  filter(city %in% c("warszawa", "gdansk")) %>%
  
  # Wywalamy bÅ‚Ä™dy cenowe (outliery)
  filter(price_per_sqm < 60000) %>%
  
  # Dodalem 'color = city', zeby sie roznily kolorami
  ggplot(aes(x = centreDistance, y = price_per_sqm, color = city)) +
  
  # Punkty troche mniejsze i bardziej przezroczyste, zeby bylo widac zageszczenie
  geom_point(alpha = 0.3, size = 1.2) +
  
  # Linia trendu
  geom_smooth(method = "gam", color = "black", se = FALSE, size = 1) + 
  
  # PodziaÅ‚ na dwa panele obok siebie
  facet_wrap(~city, scales = "free") +
  
  # Kolorki (Warszawa na czerwono, Gdansk na niebiesko - klasyk)
  scale_color_manual(values = c("ddansk" = "#2980b9", "warszawa" = "#c0392b")) +
  
  labs(
    title = "Czy im dalej od centrum, tym taniej?",
    subtitle = "PorÃ³wnanie trendÃ³w: GdaÅ„sk vs Warszawa",
    x = "OdlegÅ‚oÅ›Ä‡ od centrum (km)",
    y = "Cena za mÂ² (PLN)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none", # Legenda niepotrzebna, bo mamy podpisy nad wykresami
    strip.text = element_text(size = 14, face = "bold") # Wieksze nazwy miast
  )

wykres_odleglosci
```
<div class="info-box">
Interpretacja trendÃ³w lokalizacyjnych ukazuje zasadnicze rÃ³Å¼nice w strukturze przestrzennej obu aglomeracji:

Warszawa reprezentuje model monocentryczny, w ktÃ³rym zaleÅ¼noÅ›Ä‡ cen od lokalizacji przybiera postaÄ‡ wyraÅºnej ujemnej korelacji liniowej. NajwyÅ¼sze stawki, przekraczajÄ…ce dwadzieÅ›cia piÄ™Ä‡ tysiÄ™cy zÅ‚otych za metr kwadratowy, skupiajÄ… siÄ™ w Å›cisÅ‚ym centrum miasta. Wraz z oddalaniem siÄ™ od serca stolicy wartoÅ›Ä‡ nieruchomoÅ›ci spada w sposÃ³b niemal jednostajny, co stanowi klasyczny przykÅ‚ad renty lokalizacyjnej, gdzie odlegÅ‚oÅ›Ä‡ od centralnego punktu orientacyjnego jest gÅ‚Ã³wnym czynnikiem determinujÄ…cym cenÄ™.

GdaÅ„sk natomiast wpisuje siÄ™ w model pasmowy i policentryczny, co sprawia, Å¼e wykres cen jest znacznie bardziej zÅ‚oÅ¼ony. W promieniu dwÃ³ch kilometrÃ³w od historycznego ÅšrÃ³dmieÅ›cia wysokie ceny sÄ… podyktowane walorami turystycznymi oraz rynkiem najmu krÃ³tkoterminowego. NastÄ™pnie, w odlegÅ‚oÅ›ci trzech do czterech kilometrÃ³w, nastÄ™puje lokalny spadek cen w dzielnicach o charakterze sypialnianym, ktÃ³re mimo bliskoÅ›ci starÃ³wki nie posiadajÄ… jej prestiÅ¼u. Kolejny wzrost stawek obserwuje siÄ™ w przedziale od piÄ™ciu do dziewiÄ™ciu kilometrÃ³w. Wynika to ze specyfiki Centralnego Pasma UsÅ‚ugowego, obejmujÄ…cego biznesowe oÅ›rodki w Oliwie i Wrzeszczu, oraz atrakcyjnoÅ›ci pasa nadmorskiego. W rezultacie w GdaÅ„sku centrum nie stanowi pojedynczego punktu, lecz oÅ› komunikacyjnÄ…, co powoduje, Å¼e nieruchomoÅ›ci poÅ‚oÅ¼one daleko od zabytkowego rdzenia miasta mogÄ… osiÄ…gaÄ‡ wyceny porÃ³wnywalne z ofertami w samym ÅšrÃ³dmieÅ›ciu.
</div>



```{r Mapa_Hex_Patchwork, echo=FALSE, message=FALSE, warning=FALSE, fig.height=7, fig.width=14, fig.align="center"}
# Instalujemy/Å‚adujemy bibliotekÄ™ do Å‚Ä…czenia wykresÃ³w
if (!require("patchwork")) install.packages("patchwork")
library(patchwork)
library(ggplot2)
library(dplyr)
library(hexbin)
library(viridis)
library(osmdata)
library(sf)

# --- 1. PRZYGOTOWANIE DANYCH ---
static_data <- apartments_final %>%
  mutate(city_norm = tolower(city)) %>%
  filter(city_norm %in% c("gdansk", "gdaÅ„sk", "warszawa")) %>%
  mutate(city = if_else(grepl("gdansk|gdaÅ„sk", city_norm), "GdaÅ„sk", "Warszawa")) %>%
  mutate(buildYear = as.numeric(as.character(buildYear))) %>%
  filter(!is.na(buildYear), buildYear >= 1900, buildYear <= 2026) %>%
  filter(!is.na(latitude), !is.na(longitude))

# --- 2. POBIERANIE GRANIC ---
pobierz_granice <- function(miasto_osm) {
  tryCatch({
    granica <- opq(bbox = miasto_osm, timeout = 60) %>% 
      add_osm_feature(key = "admin_level", value = "8") %>% 
      osmdata_sf()
    granica$osm_multipolygons %>% filter(name == miasto_osm)
  }, error = function(e) return(NULL))
}

granica_gda <- NULL
granica_wwa <- NULL
try({
  granica_gda <- pobierz_granice("GdaÅ„sk")
  granica_wwa <- pobierz_granice("Warszawa")
}, silent = TRUE)

# --- 3. FUNKCJA RYSUJÄ„CA JEDNO MIASTO ---
rysuj_miasto <- function(dane, granice, nazwa_miasta) {
  
  # Filtrujemy dane dla konkretnego miasta
  dane_miasta <- dane %>% filter(city == nazwa_miasta)
  
  ggplot() +
    # TÅ‚o (czarne)
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), fill = "#101010") +
    
    # Granice (jeÅ›li sÄ…)
    {if (!is.null(granice)) geom_sf(data = granice, fill = "#1a1a1a", color = "#555555", size = 0.8)} +
    
    # Hexbiny
    stat_summary_hex(
      data = dane_miasta,
      aes(x = longitude, y = latitude, z = buildYear),
      fun = median, 
      bins = 40, # Mniej binÃ³w bo wykresy bÄ™dÄ… mniejsze
      color = "black", 
      size = 0.1
    ) +
    
    # Skala kolorÃ³w
    scale_fill_viridis_c(
      option = "magma", 
      limits = c(1950, 2024), # Sztywna skala, Å¼eby kolory znaczyÅ‚y to samo na obu mapach!
      oob = scales::squish,   # Jak coÅ› jest starsze niÅ¼ 1950, traktuj jak 1950
      name = "Rok budowy"
    ) +
    
    labs(title = nazwa_miasta) +
    theme_void() +
    theme(
      plot.background = element_rect(fill = "#101010", color = NA),
      panel.background = element_rect(fill = "#101010", color = NA),
      text = element_text(color = "white"),
      plot.title = element_text(size = 22, face = "bold", hjust = 0.5, margin = margin(b = 10)),
      legend.position = "none" # LegendÄ™ dodamy osobno na koÅ„cu
    )
}

# --- 4. TWORZENIE DWÃ“CH WYKRESÃ“W ---
p_gda <- rysuj_miasto(static_data, granica_gda, "GdaÅ„sk")
p_wwa <- rysuj_miasto(static_data, granica_wwa, "Warszawa")

# --- 5. ÅÄ„CZENIE (MAGIA PATCHWORK) ---
# SkÅ‚adamy dwa wykresy obok siebie i dodajemy wspÃ³lnÄ… legendÄ™
final_plot <- (p_gda + p_wwa) +
  plot_layout(guides = "collect") & # WspÃ³lna legenda
  theme(
    legend.position = "bottom",
    legend.background = element_rect(fill = "#101010"),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    legend.key.width = unit(2, "cm")
  )

# Dodajemy nagÅ‚Ã³wek do caÅ‚oÅ›ci
final_plot + plot_annotation(
  title = "Gdzie buduje siÄ™ nowe?",
  subtitle = "Analiza przestrzenna wieku tkanki miejskiej (Mediana roku budowy)",
  caption = "Szary kontur = granice miasta | Kolorowe punkty = oferty sprzedaÅ¼y",
  theme = theme(
    plot.background = element_rect(fill = "#101010", color = NA),
    plot.title = element_text(size = 26, face = "bold", color = "white", hjust = 0.5),
    plot.subtitle = element_text(size = 16, color = "#cccccc", hjust = 0.5),
    plot.caption = element_text(size = 12, color = "#888888")
  )
)
```
<div class="info-box">
Analiza przestrzenna struktury wieku zabudowy wykorzystuje agregacjÄ™ heksagonalnÄ…, co pozwala na precyzyjne zbadanie rozkÅ‚adu inwestycji mieszkaniowych. PrzyjÄ™cie mediany roku budowy jako gÅ‚Ã³wnego wskaÅºnika umoÅ¼liwia pominiÄ™cie wpÅ‚ywu pojedynczych, wspÃ³Å‚czesnych obiektÃ³w w starszych dzielnicach i skupienie siÄ™ na dominujÄ…cym charakterze architektonicznym danego rejonu.

Zestawienie to ukazuje dwa odmienne modele rozwoju aglomeracji. W Warszawie obserwujemy model monocentryczny, potocznie okreÅ›lany mianem efektu obwarzanka. ÅšrÃ³dmieÅ›cie oraz przylegÅ‚e do niego dzielnice, takie jak MokotÃ³w, Ochota czy Å»oliborz, tworzÄ… ciemniejszy rdzeÅ„ zdominowany przez tkankÄ™ historycznÄ… oraz budownictwo z okresu PRL. Z kolei na obrzeÅ¼ach miasta, w dzielnicach takich jak BiaÅ‚oÅ‚Ä™ka, Ursus czy WilanÃ³w, wyraÅºnie zarysowuje siÄ™ jasny pierÅ›cieÅ„ nowej zabudowy. Åšwiadczy to o intensywnym procesie rozlewania siÄ™ miasta i wypychaniu najnowszych inwestycji na peryferia, gdzie wiÄ™ksza dostÄ™pnoÅ›Ä‡ gruntÃ³w pozwala na zachowanie niÅ¼szych cen.

GdaÅ„sk prezentuje odmienny, pasmowy model rozwoju, silnie skorelowany z gÅ‚Ã³wnÄ… osiÄ… komunikacyjnÄ… oraz liniÄ… kolejowÄ…. Starsza zabudowa koncentruje siÄ™ wzdÅ‚uÅ¼ tego ciÄ…gu oraz w historycznym ÅšrÃ³dmieÅ›ciu. Ekspansja nowych inwestycji nie ma tu charakteru pierÅ›cieniowego, lecz kieruje siÄ™ przede wszystkim na poÅ‚udnie, poza liniÄ™ obwodnicy, tworzÄ…c nowoczesne dzielnice sypialniane w rejonie Jasienia i GdaÅ„ska PoÅ‚udnie. PorÃ³wnanie obu miast prowadzi do wniosku, Å¼e o ile w stolicy nowe budownictwo jest toÅ¼same z duÅ¼Ä… odlegÅ‚oÅ›ciÄ… od centrum, o tyle w GdaÅ„sku inwestycje te albo intensywnie uzupeÅ‚niajÄ… luki w pasie nadmorskim, albo tworzÄ… skondensowany oÅ›rodek mieszkaniowy na poÅ‚udniowych kraÅ„cach aglomeracji.
</div>
```{r Statystyki_WWA_GDA_Pokoje, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(DT)
library(e1071)
tabela_pokoje <- apartments_final %>%
  filter(city %in% c("warszawa", "gdansk")) %>%
  filter(rooms >= 1 & rooms <= 4) %>% 
  mutate(Kategoria = paste0(city, " (", rooms, " p.)")) %>% 
  group_by(Kategoria) %>%
  summarise(
    Min = min(price, na.rm = TRUE),
    `Kwartyl dolny` = quantile(price, 0.25, na.rm = TRUE),
    Mediana = median(price, na.rm = TRUE),
    `Kwartyl gÃ³rny` = quantile(price, 0.75, na.rm = TRUE),
    Max = max(price, na.rm = TRUE),
    Åšrednia = mean(price, na.rm = TRUE),
    `Odch. std.` = sd(price, na.rm = TRUE),
    IQR = IQR(price, na.rm = TRUE),
    `SkoÅ›noÅ›Ä‡` = skewness(price, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = -Kategoria, names_to = "Statystyka", values_to = "WartoÅ›Ä‡") %>%
  pivot_wider(names_from = Kategoria, values_from = WartoÅ›Ä‡) %>%
  mutate(across(where(is.numeric), ~ round(., 2)))


kolumny_dane <- sort(names(tabela_pokoje)[-1])
tabela_pokoje <- tabela_pokoje %>% select("Statystyka", all_of(kolumny_dane))


cols_gdansk <- grep("gdansk", names(tabela_pokoje), value = TRUE)
cols_wawa   <- grep("warszawa", names(tabela_pokoje), value = TRUE)


datatable(tabela_pokoje,
          extensions = 'FixedColumns', 
          options = list(
            pageLength = 15,
            scrollX = TRUE,      
            dom = 't',
            fixedColumns = list(leftColumns = 1) 
          ),
          class = 'cell-border hover',
          rownames = FALSE,
          caption = 'SzczegÃ³Å‚owa analiza cen: PodziaÅ‚ na pokoje (GdaÅ„sk vs Warszawa)') %>%
  

  formatStyle(
    columns = cols_gdansk,
    backgroundColor = styleInterval(c(0), c('#eaf2f8', '#d4e6f1')), 
    color = '#154360',
    fontWeight = 'bold'
  ) %>%
  

  formatStyle(
    columns = cols_wawa,
    backgroundColor = styleInterval(c(0), c('#fdedec', '#fadbd8')), 
    color = '#78281f',
    fontWeight = 'bold'
  ) %>%
  
  
  formatCurrency(
    columns = names(tabela_pokoje)[-1], 
    currency = "", 
    interval = 3, 
    mark = " ", 
    digits = 0
  )
```
<div class="info-box">
Przedstawione dane wskazujÄ… na systematyczny wzrost cen nieruchomoÅ›ci wraz z liczbÄ… pokoi, przy czym Warszawa konsekwentnie pozostaje rynkiem droÅ¼szym od GdaÅ„ska we wszystkich kategoriach. RÃ³Å¼nice te pogÅ‚Ä™biajÄ… siÄ™ wraz z metraÅ¼em, co widaÄ‡ szczegÃ³lnie w segmencie lokali czteropokojowych, gdzie mediana w stolicy jest o blisko 400 tys. zÅ‚ wyÅ¼sza niÅ¼ w GdaÅ„sku. W obu miastach wystÄ™puje prawostronna asymetria rozkÅ‚adu oraz rosnÄ…ce rozproszenie cen w wiÄ™kszych mieszkaniach, co sugeruje duÅ¼y wpÅ‚yw ofert luksusowych na Å›rednie rynkowe, zwÅ‚aszcza w Warszawie, gdzie ceny maksymalne osiÄ…gajÄ… poziom 3 mln zÅ‚.
</div>
## 3.3 Testy statystyczne
```{r setup_stats, echo=FALSE, message=FALSE, warning=FALSE}
echo=FALSE
library(dplyr)
library(rstatix)
library(ggpubr)
library(gplots)
library(ggplot2)
library(car)
library(ggstatsplot)



apartments_stat <- apartments_final %>%
  filter(!is.na(price), !is.na(floor), !is.na(poiCount)) %>%
  mutate(
   
    floor_group = case_when(
      floor == 0 ~ "Parter",
      floor >= 1 & floor <= 4 ~ "Niskie (1-4)",
      floor >= 5 & floor <= 10 ~ "Åšrednie (5-10)",
      floor > 10 ~ "Wysokie (11+)",
      TRUE ~ "Inne"
    ),
 
    floor_group = factor(floor_group, levels = c("Parter", "Niskie (1-4)", "Åšrednie (5-10)", "Wysokie (11+)")),
    
    
    poi_group = ntile(poiCount, 3), 
    poi_label = factor(case_when(
      poi_group == 1 ~ "MaÅ‚a dostÄ™pnoÅ›Ä‡ usÅ‚ug",
      poi_group == 2 ~ "Åšrednia dostÄ™pnoÅ›Ä‡",
      poi_group == 3 ~ "DuÅ¼a dostÄ™pnoÅ›Ä‡ usÅ‚ug"
    ), levels = c("MaÅ‚a dostÄ™pnoÅ›Ä‡ usÅ‚ug", "Åšrednia dostÄ™pnoÅ›Ä‡", "DuÅ¼a dostÄ™pnoÅ›Ä‡ usÅ‚ug")),
    
    type = as.factor(type),
    city = as.factor(city),
    hasElevator = as.factor(hasElevator)
  )
levene_result <- leveneTest(price ~ type, data = apartments_stat)
print(levene_result)

ggbetweenstats(
  data = apartments_stat,
  x = type,
  y = price,
  type = "p",            
  var.equal = FALSE,      
  pairwise.display = "significant", 
  title = "Czy typ budynku rÃ³Å¼nicuje cenÄ™?",
  xlab = "Rodzaj budynku",
  ylab = "Cena ofertowa (PLN)",
  messages = FALSE
)
```
<div class="info-box">
**Do sekcji 1 Typ budynku:**
Przeprowadzony test ANOVA (Welcha) wykazaÅ‚ bardzo silnÄ… istotnoÅ›Ä‡ statystycznÄ… ($p < 0.001$). Odrzucamy hipotezÄ™ zerowÄ… â€“ rodzaj budynku jest kluczowym czynnikiem rÃ³Å¼nicujÄ…cym cenÄ™.

Ranking cenowy: 
NajwyÅ¼sze Å›rednie ceny osiÄ…gajÄ… apartamentowce (apartmentBuilding) (Å›r. ~1.13 mln PLN). SÄ… one zdecydowanie droÅ¼sze od kamienic (tenement) (Å›r. ~909 tys. PLN) oraz blokÃ³w (blockOfFlats), ktÃ³re stanowiÄ… segment najtaÅ„szy (Å›r. ~713 tys. PLN).Wnioski: Testy post-hoc (Gamesa-Howella) potwierdzajÄ…, Å¼e rÃ³Å¼nice miÄ™dzy kaÅ¼dÄ… parÄ… tych grup sÄ… istotne statystycznie. Typ budynku jest jednym z najsilniejszych predyktorÃ³w ceny w badanym zbiorze.
</div>
```{r setup_stats1, echo=FALSE, message=FALSE, warning=FALSE}
echo=FALSE
ggbetweenstats(
  data = apartments_stat,
  x = floor_group,
  y = price,
  type = "p",
  var.equal = FALSE,
  pairwise.display = "significant",
  title = "WpÅ‚yw kondygnacji na cenÄ™",
  xlab = "Grupa piÄ™ter",
  ylab = "Cena ofertowa (PLN)",
  messages = FALSE
)
```
<div class="info-box">
**Do sekcji 2 PiÄ™tro:**
Analiza wykazaÅ‚a istotne statystycznie rÃ³Å¼nice w cenach w zaleÅ¼noÅ›ci od kondygnacji ($p < 0.001$). Obserwujemy wyraÅºny trend rosnÄ…cy:

Premia za widok: NajdroÅ¼sze sÄ… mieszkania na wysokich piÄ™trach (11+) (Å›r. ~961 tys. PLN).Standard: Mieszkania na piÄ™trach niskich (1-4) i Å›rednich (5-10) osiÄ…gajÄ… niÅ¼sze wyceny (odpowiednio ~815 tys. i ~855 tys. PLN).Wniosek: Rynek premiuje mieszkania poÅ‚oÅ¼one wysoko (panoramiczne), traktujÄ…c je jako towar bardziej luksusowy, podczas gdy niÅ¼sze kondygnacje w wysokiej zabudowie sÄ… wyceniane niÅ¼ej.
</div>
```{r setup_stats2, echo=FALSE, message=FALSE, warning=FALSE}
echo=FALSE
ggbetweenstats(
  data = apartments_stat,
  x = poi_label,
  y = price,
  type = "p",
  var.equal = FALSE,
  pairwise.display = "significant", 
  title = "DostÄ™pnoÅ›Ä‡ punktÃ³w usÅ‚ugowych (POI) a cena",
  xlab = "Nasycenie usÅ‚ugami (POI)",
  ylab = "Cena ofertowa (PLN)",
  messages = FALSE
)
```
<div class="info-box">
**Do sekcji 3 DostÄ™pnoÅ›Ä‡ usÅ‚ug / POI:**
Istnieje silna zaleÅ¼noÅ›Ä‡ miÄ™dzy nasyceniem okolicy usÅ‚ugami (POI) a cenÄ… ofertowÄ… nieruchomoÅ›ci ($p < 0.001$).Efekt lokalizacji: 

Mieszkania w strefach o duÅ¼ej dostÄ™pnoÅ›ci usÅ‚ug sÄ… Å›rednio o ponad 140 tys. PLN droÅ¼sze (Å›r. ~923 tys. PLN) niÅ¼ te w strefach o Å›redniej dostÄ™pnoÅ›ci (~781 tys. PLN).Wniosek: BliskoÅ›Ä‡ szkÃ³Å‚, restauracji i sklepÃ³w jest silnie skorelowana z wyÅ¼szÄ… cenÄ…, co potwierdza, Å¼e lokalizacja "wszystko pod rÄ™kÄ…" jest wysoce poÅ¼Ä…dana przez kupujÄ…cych.
</div>
```{r setup_stats3, echo=FALSE, message=FALSE, warning=FALSE}
ggbetweenstats(
  data = apartments_stat,
  x = hasElevator,
  y = price,
  type = "p", 
  var.equal = FALSE,
  title = "Czy winda podnosi wartoÅ›Ä‡ mieszkania?",
  xlab = "Czy jest winda?",
  ylab = "Cena ofertowa (PLN)",
  messages = FALSE
)
```
<div class="info-box">
**Do sekcji 4 Winda:**
Test t-Studenta (z poprawkÄ… Welcha) wskazuje na gigantycznÄ… rÃ³Å¼nicÄ™ w cenach ($p < 0.001$).

WartoÅ›Ä‡ udogodnienia: 

Mieszkania w budynkach z windÄ… sÄ… Å›rednio o blisko 180 tys. PLN droÅ¼sze (Å›r. ~914 tys. PLN) niÅ¼ te bez windy (~736 tys. PLN).Kontekst: NaleÅ¼y pamiÄ™taÄ‡, Å¼e winda czÄ™sto koreluje z nowszym budownictwem (apartamentowce) lub wyÅ¼szym standardem, podczas gdy brak windy jest typowy dla starszych blokÃ³w z wielkiej pÅ‚yty (do 4 piÄ™ter) i kamienic, co dodatkowo pogÅ‚Ä™bia rÃ³Å¼nicÄ™ cenowÄ….
</div>

# 4.Podsumowanie

## 4.1. Charakterystyka Cenowa i Struktura Rynku
<div class="info-box">
Przeprowadzona analiza danych rynkowych z 2024 roku ujawnia obraz rynku nieruchomoÅ›ci cechujÄ…cego siÄ™ silnÄ… asymetriÄ… prawostronnÄ… oraz wysokim progiem wejÅ›cia. DominujÄ…cy wolumen transakcyjny koncentruje siÄ™ w przedziale 500 000 â€“ 850 000 PLN, co wyznacza obecny standard cenowy dla typowego nabywcy. Rynek poniÅ¼ej 250 000 PLN praktycznie przestaÅ‚ istnieÄ‡, co Å›wiadczy o postÄ™pujÄ…cej inflacji aktywÃ³w.Istotnym zjawiskiem jest obecnoÅ›Ä‡ segmentu luksusowego (powyÅ¼ej 1,5 mln PLN), ktÃ³ry â€“ choÄ‡ nieliczny wolumenowo â€“ drastycznie zawyÅ¼a Å›redniÄ… arytmetycznÄ… cen. Z tego powodu to mediana pozostaje najbardziej rzetelnym wskaÅºnikiem wartoÅ›ci rynkowej. Obserwujemy wyraÅºnÄ… korelacjÄ™ miÄ™dzy metraÅ¼em a ryzykiem inwestycyjnym: segment mieszkaÅ„ 1- i 2-pokojowych jest stabilny i jednorodny, podczas gdy rynek lokali 3- i 4-pokojowych wykazuje ogromnÄ… dyspersjÄ™ cenowÄ…, wynikajÄ…cÄ… z silnie rozwiniÄ™tego sektora premium.
</div>
## 4.2. Hierarchia TypÃ³w Zabudowy i StandarduBadanie
<div class="info-box">
struktury cenowej wg typu zabudowy (testy ANOVA) potwierdza istnienie sztywnej hierarchii prestiÅ¼u:

Apartamentowce: Lider rynku pod wzglÄ™dem mediany cen (~1,13 mln PLN) i stabilnoÅ›ci inwestycyjnej. To segment najdroÅ¼szy, charakteryzujÄ…cy siÄ™ najniÅ¼szym wspÃ³Å‚czynnikiem zmiennoÅ›ci.

Kamienice: Rynek o charakterze dwumodalnym i najwyÅ¼szym ryzyku (najwiÄ™kszy rozstÄ™p miÄ™dzykwartylowy). Ceny sÄ… spolaryzowane miÄ™dzy zrujnowanymi lokalami a luksusowymi rewitalizacjami.

Bloki: Najbardziej przewidywalny i przystÄ™pny cenowo segment (Å›r. ~713 tys. PLN), stanowiÄ…cy fundament rynku masowego.

Analiza techniczna wykazaÅ‚a gigantycznÄ… premiÄ™ za udogodnienia: obecnoÅ›Ä‡ windy podnosi Å›redniÄ… wartoÅ›Ä‡ mieszkania o blisko 180 000 PLN, a lokale na wysokich piÄ™trach (11+) sÄ… wyceniane istotnie wyÅ¼ej niÅ¼ te na niÅ¼szych kondygnacjach, co potwierdza zjawisko â€premii za widokâ€.
</div>
## 4.3. Geografia Cen i Modele Rozwoju Miast
<div class="info-box">
Polska pozostaje rynkiem gÅ‚Ä™boko spolaryzowanym. Warszawa (Å›r. >18 000 PLN/mÂ²) deklasuje pozostaÅ‚e oÅ›rodki, tworzÄ…c wraz z TrÃ³jmiastem i Krakowem grupÄ™ â€rynkÃ³w tier-1â€. Miasta takie jak Radom czy CzÄ™stochowa, z cenami poniÅ¼ej 7 500 PLN/mÂ², stanowiÄ… odrÄ™bny biegun ekonomiczny.

SzczegÃ³Å‚owa analiza porÃ³wnawcza Warszawy i GdaÅ„ska ujawniÅ‚a dwa odmienne modele urbanistyczne:

Warszawa (Model Monocentryczny):WystÄ™puje tu klasyczna renta lokalizacyjna â€“ cena spada liniowo wraz z oddalaniem siÄ™ od PaÅ‚acu Kultury. Nowe inwestycje sÄ… wypychane na peryferia (â€efekt obwarzankaâ€), tworzÄ…c jasny pierÅ›cieÅ„ nowej zabudowy wokÃ³Å‚ ciemniejszego, historycznego rdzenia.

GdaÅ„sk (Model Policentryczny/Pasmowy): Ceny nie spadajÄ… liniowo.Nowa zabudowa nie otacza miasta, lecz ekspanduje na poÅ‚udnie oraz wypeÅ‚nia luki w pasie nadmorskim.
</div>
## 4.4. WpÅ‚yw Infrastruktury (POI) na WycenÄ™
<div class="info-box">
Analiza korelacji wskazuje, Å¼e dostÄ™pnoÅ›Ä‡ usÅ‚ug (Points of Interest) jest najsilniejszym pozytywnym predyktorem ceny za mÂ². ZaleÅ¼noÅ›Ä‡ ta nie jest jednak liniowa â€“ rynek najlepiej wycenia lokalizacje z 50â€“130 punktami usÅ‚ugowymi w zasiÄ™gu (cena >20 000 PLN/mÂ²). PowyÅ¼ej tej liczby (Å›cisÅ‚e, gÅ‚oÅ›ne centra) wzrost cen wyhamowuje. Potwierdza to tezÄ™, Å¼e nabywcy szukajÄ… kompromisu miÄ™dzy dostÄ™pnoÅ›ciÄ… usÅ‚ug a komfortem Å¼ycia.
</div>
## 4.5. Wnioski z Wnioskowania Statystycznego
<div class="info-box">
Przeprowadzone testy parametryczne (Welch ANOVA, Games-Howell) na prÃ³bie ponad 20 tys. ofert pozwoliÅ‚y na sformuÅ‚owanie wnioskÃ³w o wysokim poziomie istotnoÅ›ci statystycznej ($p < 0.001$):

Typ budynku jest kluczowym dyskryminatorem ceny (apartamentowiec > kamienica > blok).

Lokalizacja wertykalna ma znaczenie: najwyÅ¼sze piÄ™tra sÄ… towarem luksusowym, partery i niskie piÄ™tra sÄ… wyceniane niÅ¼ej.

Infrastruktura bezpoÅ›rednio przekÅ‚ada siÄ™ na wartoÅ›Ä‡: strefy o wysokim nasyceniu POI sÄ… Å›rednio o 140 000 PLN droÅ¼sze od stref o nasyceniu Å›rednim.

Konkluzja: Rynek w 2024 roku jest rynkiem dojrzaÅ‚ym, ale silnie rozwarstwionym. Najbezpieczniejszymi aktywami sÄ… maÅ‚e i Å›rednie lokale w apartamentowcach oraz nieruchomoÅ›ci w dobrze skomunikowanych dzielnicach GdaÅ„ska i Warszawy. Inwestycje w duÅ¼e metraÅ¼e (>4 pokoje) oraz kamienice obarczone sÄ… znacznie wyÅ¼szym ryzykiem zmiennoÅ›ci cenowej.
</div>


