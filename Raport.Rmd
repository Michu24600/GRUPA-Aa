---
title: "Analiza Rynku Mieszkaniowego"
subtitle: "Raport analityczny "
author: "Kacper Ciszewski, MichaÅ‚ Dalach, Wiktor Drozdowski"
date: "`r Sys.Date()`"
odate: "`r Sys.Date()`"
output: 
  html_document:
    theme: 
      bootstrap: 5
      base_font: !expr bslib::font_google("Outfit") # Nowoczesny, geometryczny font
      heading_font: !expr bslib::font_google("Montserrat")
      primary: "#2C3E50" # Ciemny granat korporacyjny
      secondary: "#E74C3C" # Akcent czerwony dla kontrastu
    toc: true              
    toc_float: 
      collapsed: true
    smooth_scroll: true
    number_sections: false
    highlight: pygments # Åadniejsze kolorowanie kodu
---

<style>
/* GÅ‚Ã³wny kontener raportu */
body {
  background-color: #f8f9fa; /* Delikatne szare tÅ‚o, by biaÅ‚e wykresy "wychodziÅ‚y" do przodu */
  color: #333333;
  line-height: 1.7;
}

/* Karta z treÅ›ciÄ… */
.main-container {
  max-width: 1100px !important;
  background-color: white;
  padding: 40px !important;
  box-shadow: 0 0 20px rgba(0,0,0,0.05);
  margin-top: 30px;
  border-radius: 8px;
}

/* NagÅ‚Ã³wki */
h1 {
  color: #2C3E50;
  font-weight: 800;
  border-left: 6px solid #2C3E50;
  padding-left: 15px;
  margin-top: 1.5em;
}

h2 {
  color: #34495E;
  font-weight: 700;
  margin-top: 1.2em;
  text-transform: uppercase;
  letter-spacing: 1px;
  font-size: 1.2em;
}

/* Stylowanie tabel DT */
.dataTables_wrapper {
  font-family: 'Inter', sans-serif;
  font-size: 0.9em;
}

/* PÅ‚ywajÄ…ce menu (TOC) */
#TOC {
  border: none;
  background-color: rgba(255,255,255,0.8);
  backdrop-filter: blur(5px);
  border-radius: 10px;
  padding: 10px;
}

/* Wykresy i obrazki */
img, .plotly, .html-widget {
  border-radius: 12px;
  transition: transform .3s; /* Efekt po najechaniu */
}

img:hover {
  transform: scale(1.01);
  box-shadow: 0 10px 20px rgba(0,0,0,0.12);
}

/* WyrÃ³Å¼nione bloki tekstu (zastÄ…p divy tymi klasami) */
.info-box {
  padding: 20px;
  background-color: #e9ecef;
  border-radius: 10px;
  border-left: 5px solid #2C3E50;
  margin: 20px 0;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(bslib)
```

```{r biblioteki, echo=FALSE, message=FALSE, warning=FALSE, fig.height=8,fig.width=16}
library(dplyr)
library(naniar)
library(VIM)
library(tidyr)
library(randomForest)
library(validate)
library(leaflet)
library(scales)
library(ggplot2)
library(hexbin)
library(gganimate)
library(gifski) 
library(ggmap)
library(shiny)
library(shinythemes)
```

# 1. WstÄ™p i Cel Projektu
<div class="info-box">
**ğŸ¯ Cel Analizy**: Celem niniejszego badania jest zidentyfikowanie oraz ocena siÅ‚y oddziaÅ‚ywania kluczowych determinant cenowych na rynku nieruchomoÅ›ci mieszkalnych w Polsce. Analiza koncentruje siÄ™ na wielowymiarowym badaniu zaleÅ¼noÅ›ci miÄ™dzy cechami fizycznymi lokalu, infrastrukturÄ… otoczenia a cenÄ… transakcyjnÄ…. Projekt zakÅ‚ada *dwuetapowÄ… weryfikacjÄ™ hipotez*: w ujÄ™ciu globalnym (dla caÅ‚ego zbioru danych) oraz w ujÄ™ciu lokalnym, poprzez szczegÃ³Å‚owÄ… analizÄ™ specyfiki wybranych rynkÃ³w miejskich (np. Warszawy,GdaÅ„ska), co pozwoli na uchwycenie niuansÃ³w lokalizacyjnych wpÅ‚ywajÄ…cych na wycenÄ™.
</div>
## 1.1 O Danych
<div class="info-box">
Analiza zostaÅ‚a przeprowadzona na zbiorze danych zawierajÄ…cym oferty sprzedaÅ¼y mieszkaÅ„ z czerwca 2024 roku.

**Å¹rÃ³dÅ‚o danych:** [<https://www.kaggle.com/datasets/krzysztofjamroz/apartment-prices-in-poland/?select=apartments_pl_2023_08.csv>] 
</div>
## 1.2. ğŸ“– SÅ‚ownik Zmiennych (Data Dictionary)
<div class="info-box">
PoniÅ¼sza tabela przedstawia opis zmiennych dostÄ™pnych w analizowanym zbiorze danych:
</div>
```{r data_dictionary, echo=FALSE,message=FALSE,warning=FALSE}
# Najpierw upewnij siÄ™, Å¼e masz pakiet: install.packages("kableExtra")
library(kableExtra)
library(dplyr)

# Tworzymy dane rÄ™cznie
slownik <- tibble::tribble(
  ~"Nazwa Zmiennej", ~"Opis", 
  "id", "Unikalny identyfikator ogÅ‚oszenia", 
  "city", "Miasto, w ktÃ³rym znajduje siÄ™ nieruchomoÅ›Ä‡", 
  "price", "Cena ofertowa (PLN) ", 
  "squareMeters", "Powierzchnia mieszkania w mÂ²", 
  "rooms", "Liczba pokoi", 
  "floor / floorCount", "PiÄ™tro mieszkania / Liczba piÄ™ter", 
  "buildYear", "Rok budowy budynku", 
  "type", "Rodzaj zabudowy ", 
  "ownership", "Forma wÅ‚asnoÅ›ci", 
  "lat / lon", "WspÃ³Å‚rzÄ™dne geograficzne", 
  "centreDistance", "OdlegÅ‚oÅ›Ä‡ od centrum (km)", 
  "poiCount", "Liczba punktÃ³w POI (500m)", 
  "*Distance", "OdlegÅ‚oÅ›ci do: szkÃ³Å‚, przychodni itp.", 
  "has*Parking, Balkon, Winda, Ochrona...", "Czy ma dane udogodnienie (TAK/NIE)", 
)

kbl(slownik, caption = "SÅ‚ownik Zmiennych (Data Dictionary)") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), 
                full_width = F, 
                position = "center",
                font_size = 14) %>%
  row_spec(0, bold = TRUE, color = "white", background = "#2c3e50") %>% 
  column_spec(1, bold = TRUE, color = "#2980b9") 
```

# 2. PorzÄ…dkowanie i czyszczenie danych
<div class="info-box">
Proces przygotowania danych do analizy zostaÅ‚ podzielony na kilka kluczowych etapÃ³w: definicjÄ™ reguÅ‚ poprawnoÅ›ci, wstÄ™pnÄ… walidacjÄ™, imputacjÄ™ brakÃ³w danych (metodami statystycznymi i uczenia maszynowego) oraz weryfikacjÄ™ koÅ„cowÄ….
</div>
## 2.1. Definicja ReguÅ‚ Walidacyjnych
<div class="info-box">
Przed przystÄ…pieniem do czyszczenia zdefiniowano zestaw reguÅ‚ logicznych przy uÅ¼yciu pakietu validate. PozwoliÅ‚o to na identyfikacjÄ™ bÅ‚Ä™dÃ³w w surowym zbiorze danych.

Sprawdzono m.in.:

SpÃ³jnoÅ›Ä‡ logicznÄ…: Czy piÄ™tro mieszkania nie jest wyÅ¼sze niÅ¼ liczba piÄ™ter w budynku (Logic_Floor).

Zasady budowlane: Czy w budynkach jednopiÄ™trowych nie zadeklarowano windy (Logic_Elevator).

WiarygodnoÅ›Ä‡ cen: Czy cena mieÅ›ci siÄ™ w przedziale 100 tys. â€“ 10 mln PLN.

GeolokalizacjÄ™: Czy wspÃ³Å‚rzÄ™dne geograficzne znajdujÄ… siÄ™ w granicach Polski (Bounding Box).

KompletnoÅ›Ä‡ dystansÃ³w: Czy odlegÅ‚oÅ›ci do punktÃ³w POI sÄ… wartoÅ›ciami dodatnimi.

WstÄ™pna walidacja wykazaÅ‚a naruszenia, ktÃ³re zostaÅ‚y skorygowane w kolejnych krokach.
</div>
```{r Wykres obrazujÄ…cy naruszenia, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
if (!require("validate")) install.packages("validate")
library(validate)
if(file.exists("apartments_data_2024_06.RData")) {
  load("apartments_data_2024_06.RData")
}
rules_apartments <- validator(
  Logic_Floor = floorCount >= floor,
  Logic_Small_Apt = if (squareMeters <= 20) rooms <= 3,
  Logic_Elevator = if (floorCount <= 1) hasElevator == "no",
  Range_Price = price >= 100000 & price <= 10000000,
  Geo_Poland_Lat = latitude >= 49.0 & latitude <= 54.9,
  Geo_Poland_Lon = longitude >= 14.1 & longitude <= 24.2,
  Limit_Area_Max = squareMeters < 300,
  Limit_Year_Max = buildYear < 2025,
  Positive_Basic = id > 0 & price > 0 & rooms > 0 & squareMeters > 0,
  Positive_Building = buildYear > 0 & floorCount > 0 & floor >= 0, 
  Positive_Geo_POI = latitude > 0 & longitude > 0 & poiCount >= 0,
  Positive_Distances = centreDistance > 0 & schoolDistance > 0 & clinicDistance > 0 & 
    postOfficeDistance > 0 & kindergartenDistance > 0 & restaurantDistance > 0 & 
    collegeDistance > 0 & pharmacyDistance > 0
)

cf_apartments <- confront(apartments_data_2024_06, rules_apartments)
wyniki <- summary(cf_apartments)
macierz_danych <- t(wyniki[ , c("fails", "nNA", "passes")])

#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
# Polskie etykiety dla wykresu trzeba sprawdziÄ‡ czy majÄ… sens
#!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
polskie_etykiety <- c(
  "PiÄ™tro > PiÄ™tra budynku",
  "Za duÅ¼o pokoi (kawalerki)",
  "Brak windy (niski blok)",
  "Cena poza zakresem",
  "ZÅ‚a szerokoÅ›Ä‡ geogr.",
  "ZÅ‚a dÅ‚ugoÅ›Ä‡ geogr.",
  "MetraÅ¼ > 300m",
  "Rok budowy > 2025",
  "Ujemne wartoÅ›ci (podst.)",
  "BÅ‚Ä™dy budynku (rok/piÄ™tra)",
  "BÅ‚Ä™dy Geo/POI",
  "Ujemne dystanse"
)
layout(matrix(c(1, 2), nrow = 2), heights = c(8, 1))

par(mar = c(2, 18, 4, 2)) 
barplot(macierz_danych, 
        main = "Struktura jakoÅ›ci danych (Walidacja)",
        names.arg = polskie_etykiety,
        horiz = TRUE,
        las = 1,
        col = c("#e74c3c", "#95a5a6", "#27ae60"), 
        border = NA
)

par(mar = c(0, 0, 0, 0))
plot.new() 
legend("center", 
       legend = c("BÅ‚Ä™dy", "Braki danych", "Poprawne"), 
       fill = c("#e74c3c", "#95a5a6", "#27ae60"), 
       bty = "n", 
       horiz = TRUE, 
       cex = 1.2 
)
```

## 2.2. Strategia Czyszczenia i Imputacji
<div class="info-box">
WdroÅ¼ono wieloetapowy potok przetwarzania danych (pipeline), obejmujÄ…cy:

Wykluczenie zmiennych buildingMaterial oraz condition. Decyzja ta zostaÅ‚a podyktowana znacznym stopniem niekompletnoÅ›ci danych (brakujÄ…ce wartoÅ›ci) oraz niskÄ… jakoÅ›ciÄ… informacji ÅºrÃ³dÅ‚owych, co uniemoÅ¼liwiaÅ‚o przeprowadzenie rzetelnej analizy statystycznej w tym zakresie.

Imputacja logiczna:

Braki w liczbie piÄ™ter (floor) uzupeÅ‚niono wartoÅ›ciÄ… mediany (3) lub wartoÅ›ciÄ… floorCount, jeÅ›li byÅ‚a mniejsza niÅ¼ 3.

InformacjÄ™ o windzie (hasElevator) wywnioskowano na podstawie wysokoÅ›ci budynku (przyjÄ™to, Å¼e budynki powyÅ¼ej 4 piÄ™ter posiadajÄ… windÄ™).

Imputacja statystyczna (Dystanse): BrakujÄ…ce odlegÅ‚oÅ›ci do punktÃ³w usÅ‚ugowych (\*Distance) uzupeÅ‚niono Å›redniÄ… arytmetycznÄ… obliczonÄ… lokalnie dla kaÅ¼dego miasta.

Imputacja algorytmiczna (kNN): BrakujÄ…cy rok budowy (buildYear) uzupeÅ‚niono metodÄ… k-NajbliÅ¼szych SÄ…siadÃ³w (kNN), bazujÄ…c na podobieÅ„stwie pod wzglÄ™dem liczby punktÃ³w POI oraz odlegÅ‚oÅ›ci od centrum.
</div>
```{r cleaning_logic, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# Definicja kolumn do imputacji Å›redniÄ…
distance_cols <- c(
  "collegeDistance", "clinicDistance", "restaurantDistance", 
  "pharmacyDistance", "postOfficeDistance", "kindergartenDistance", 
  "schoolDistance"
)
distance_vars_for_knn <- c("poiCount", "centreDistance")
apartments_processed <- apartments_data_2024_06 %>%
  # 1. Wykluczenie zmiennych o niskiej jakoÅ›ci
  select(-buildingMaterial, -condition) %>%
  
  # 2. Imputacja logiczna: PiÄ™tra
  # UzupeÅ‚nienie braku medianÄ… (3) lub floorCount (jeÅ›li budynek jest niÅ¼szy)
  mutate(
    floor = if_else(is.na(floor), pmin(3, floorCount), floor)
  ) %>%
  
  # 3. Imputacja logiczna: Windy
  mutate(
    hasElevator = case_when(
      (is.na(hasElevator) | hasElevator == "") & floor > 4 ~ "yes",
      (is.na(hasElevator) | hasElevator == "") & floor <= 4 ~ "no",
      TRUE ~ hasElevator
    )
  ) %>%
  
  # 4. Imputacja statystyczna: Dystanse (Å›rednia w grupach miast)
  group_by(city) %>%
  mutate(
    across(
      .cols = all_of(distance_cols),
      .fns = ~ replace(., is.na(.), mean(., na.rm = TRUE))
    )
  ) %>%
  
  # 5. Imputacja kNN: Rok budowy (buildYear)
  group_modify(~ {
    VIM::kNN(
      .x, 
      variable = "buildYear",
      dist_var = c("poiCount", "centreDistance"), 
      k = 5,
      imp_var = FALSE
    )
  }) %>%
  ungroup() %>%
  mutate(buildYear = round(buildYear))
```

## 2.3. Zaawansowana Imputacja (Random Forest)
<div class="info-box">
Do uzupeÅ‚nienia brakÃ³w w kluczowej zmiennej kategorycznej type (rodzaj zabudowy) zastosowano model uczenia maszynowego Random Forest (las losowy). Model zostaÅ‚ wytrenowany na kompletnych obserwacjach (500 drzew decyzyjnych), a nastÄ™pnie wykorzystany do predykcji typu budynku dla brakujÄ…cych rekordÃ³w, co pozwoliÅ‚o na zachowanie struktury danych lepiej niÅ¼ proste uzupeÅ‚nienie dominantÄ….
</div>
```{r random_forest, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE, results='hide'}
# -----------------------------------------------------------------------------
# Imputacja Random Forest (Type)
# -----------------------------------------------------------------------------
load("apartments_processed.RData")
is_missing_type <- is.na(apartments_processed$type)

# Trenowanie modelu
train_data <- apartments_processed[!is_missing_type, ]
train_data$type <- droplevels(train_data$type)

model_rf <- randomForest(
  type ~ ., 
  data = train_data, 
  ntree = 500,
  na.action = na.omit 
)

# Predykcja tylko dla brakujÄ…cych
predictions <- predict(model_rf, newdata = apartments_processed[is_missing_type, ])

# Wstawiamy predykcje z powrotem do gÅ‚Ã³wnego zbioru
apartments_processed$type[is_missing_type] <- predictions
```

```{r KoÅ„cowa Wersja, echo=FALSE, message=FALSE, warning=FALSE}

apartments_final <- apartments_processed %>%
  mutate(
    hasElevator = if_else(floorCount <= 1 & hasElevator == "yes", NA_character_, hasElevator)
  ) %>%
  filter(!is.na(hasElevator))
```

## 2.4. Wyniki i Weryfikacja KoÅ„cowa
<div class="info-box">
Po zakoÅ„czeniu procesu czyszczenia przeprowadzono:

PonownÄ… walidacjÄ™: Sprawdzono zgodnoÅ›Ä‡ danych z reguÅ‚ami validate.

AnalizÄ™ brakÃ³w (naniar): Potwierdzono wyeliminowanie kluczowych brakÃ³w danych.

Zapis: Przetworzony zbiÃ³r danych zostaÅ‚ zapisany do pliku .RData w celu optymalizacji wydajnoÅ›ci raportu.
</div>
```{r Wykres obrazujÄ…cy naruszenia po czyszczeniu, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
if (!require("validate")) install.packages("validate")
library(validate)
if(file.exists("apartments_final.RData")) {
  load("apartments_final.RData")
}
rules_apartments <- validator(
  Logic_Floor = floorCount >= floor,
  Logic_Small_Apt = if (squareMeters <= 20) rooms <= 3,
  Logic_Elevator = if (floorCount <= 1) hasElevator == "no",
  Range_Price = price >= 100000 & price <= 10000000,
  Geo_Poland_Lat = latitude >= 49.0 & latitude <= 54.9,
  Geo_Poland_Lon = longitude >= 14.1 & longitude <= 24.2,
  Limit_Area_Max = squareMeters < 300,
  Limit_Year_Max = buildYear < 2025,
  Positive_Basic = id > 0 & price > 0 & rooms > 0 & squareMeters > 0,
  Positive_Building = buildYear > 0 & floorCount > 0 & floor >= 0, 
  Positive_Geo_POI = latitude > 0 & longitude > 0 & poiCount >= 0,
  Positive_Distances = centreDistance > 0 & schoolDistance > 0 & clinicDistance > 0 & 
    postOfficeDistance > 0 & kindergartenDistance > 0 & restaurantDistance > 0 & 
    collegeDistance > 0 & pharmacyDistance > 0
)

cf_apartments <- confront(apartments_final, rules_apartments)
wyniki <- summary(cf_apartments)
macierz_danych <- t(wyniki[ , c("fails", "nNA", "passes")])

polskie_etykiety <- c(
  "PiÄ™tro > PiÄ™tra budynku",
  "Za duÅ¼o pokoi (kawalerki)",
  "Brak windy (niski blok)",
  "Cena poza zakresem",
  "ZÅ‚a szerokoÅ›Ä‡ geogr.",
  "ZÅ‚a dÅ‚ugoÅ›Ä‡ geogr.",
  "MetraÅ¼ > 300m",
  "Rok budowy > 2025",
  "Ujemne wartoÅ›ci (podst.)",
  "BÅ‚Ä™dy budynku (rok/piÄ™tra)",
  "BÅ‚Ä™dy Geo/POI",
  "Ujemne dystanse"
)
layout(matrix(c(1, 2), nrow = 2), heights = c(8, 1))

par(mar = c(2, 18, 4, 2)) 
barplot(macierz_danych, 
        main = "Struktura jakoÅ›ci danych (Walidacja)",
        names.arg = polskie_etykiety,
        horiz = TRUE,
        las = 1,
        col = c("#e74c3c", "#95a5a6", "#27ae60"), 
        border = NA
)

par(mar = c(0, 0, 0, 0))
plot.new() 
legend("center", 
       legend = c("BÅ‚Ä™dy", "Braki danych", "Poprawne"), 
       fill = c("#e74c3c", "#95a5a6", "#27ae60"), 
       bty = "n", 
       horiz = TRUE, 
       cex = 1.2 
)
```

# 3. Analiza opisowa rynku nieruchomoÅ›ci

<div class="info-box">

RozdziaÅ‚ ten stanowi szczegÃ³Å‚owÄ… analizÄ™ zebranych danych, majÄ…cÄ… na celu zrozumienie mechanizmÃ³w rzÄ…dzÄ…cych polskim rynkiem nieruchomoÅ›ci w 2026 roku. Przeprowadzona analiza opisowa pozwala zidentyfikowaÄ‡ kluczowe trendy cenowe oraz zrozumieÄ‡, jakie czynniki techniczne i lokalizacyjne w najwiÄ™kszym stopniu ksztaÅ‚tujÄ… wartoÅ›Ä‡ ofert. DziÄ™ki wykorzystaniu miar tendencji centralnej oraz metod wizualizacji, moÅ¼liwe jest oddzielenie typowych transakcji od zjawisk o charakterze luksusowym czy marginalnym. Stanowi to fundament do dalszych, bardziej zaawansowanych wnioskÃ³w dotyczÄ…cych opÅ‚acalnoÅ›ci inwestycji w konkretnych segmentach rynku.

</div>

## 3.1 OgÃ³lna charakterystyka cen mieszkaÅ„ w Polsce

```{r RozkÅ‚ad cen mieszkaÅ„ (Histogram), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot1 <- ggplot(apartments_final, aes(x = price)) +
  geom_histogram(bins = 50, fill = "#4E84C4", color = "white", alpha = 0.8) +
  scale_x_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  labs(
    title = "RozkÅ‚ad cen mieszkaÅ„",
    subtitle = "Jak ksztaÅ‚tuje siÄ™ rozkÅ‚ad cen mieszkaÅ„ w Polsce",
    x = "Cena (PLN)",
    y = "Liczba ofert"
  ) +
  theme(plot.title = element_text(face = "bold", size = 14))

print(plot1)
```


<div class="info-box">

RozkÅ‚ad cen cechuje siÄ™ silnÄ… asymetriÄ… prawostronnÄ…, z najwiÄ™kszÄ… koncentracjÄ… ofert w przedziale od 500 000 do 850 000 PLN. Dominacja tego segmentu wyznacza rynkowy standard cenowy, podczas gdy oferty powyÅ¼ej 1,5 mln PLN stanowiÄ… nielicznÄ… grupÄ™ nieruchomoÅ›ci luksusowych. WyraÅºny brak ogÅ‚oszeÅ„ poniÅ¼ej 250 000 PLN definiuje wysoki prÃ³g wejÅ›cia na badany rynek. ObecnoÅ›Ä‡ wartoÅ›ci odstajÄ…cych, siÄ™gajÄ…cych nawet 3 mln PLN, powoduje, Å¼e Å›rednia arytmetyczna jest zawyÅ¼ona. W konsekwencji to mediana, a nie Å›rednia, najlepiej oddaje realny koszt zakupu typowego mieszkania.

</div>

```{r RozkÅ‚ad cen wzglÄ™dem liczby pokoi (Price vs Rooms - Boxplot), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot2 <- ggplot(apartments_final, aes(x = as.factor(rooms), y = price, fill = as.factor(rooms))) +
  geom_boxplot(alpha = 0.7, outlier.colour = "red", outlier.shape = 1, outlier.alpha = 0.5) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  scale_fill_brewer(palette = "Set3") + # Åadna paleta kolorÃ³w
  labs(
    title = "Cena mieszkania a liczba pokoi",
    subtitle = "RozkÅ‚ad cen",
    x = "Liczba pokoi",
    y = "Cena (PLN)",
    fill = "Liczba pokoi"
  ) +
  theme(legend.position = "none") # Ukrywamy legendÄ™, bo oÅ› X wszystko wyjaÅ›nia

print(plot2)
```


<div class="info-box">

Wykres prezentuje wyraÅºnÄ… korelacjÄ™ dodatniÄ… miÄ™dzy liczbÄ… pokoi a cenÄ… nieruchomoÅ›ci, przy czym wraz ze wzrostem metraÅ¼u obserwuje siÄ™ nie tylko wzrost mediany, ale takÅ¼e znaczÄ…ce rozszerzenie rozstÄ™pu miÄ™dzykwartylowego. Rynek mieszkaÅ„ 1- i 2-pokojowych charakteryzuje siÄ™ najwiÄ™kszÄ… stabilnoÅ›ciÄ… i koncentracjÄ… cenowÄ…, gdzie niski prÃ³g wejÅ›cia oscyluje wokÃ³Å‚ 400 000 PLN, natomiast segmenty 3- i 4-pokojowe wykazujÄ… silnÄ… asymetriÄ™ prawostronnÄ… z licznymi wartoÅ›ciami odstajÄ…cymi siÄ™gajÄ…cymi nawet 3 mln PLN. ObecnoÅ›Ä‡ tak wysokich wartoÅ›ci ekstremalnych w segmencie Å›redniej wielkoÅ›ci mieszkaÅ„ Å›wiadczy o silnie rozwiniÄ™tym rynku premium, ktÃ³ry istotnie zawyÅ¼a Å›redniÄ… arytmetycznÄ…, czyniÄ…c medianÄ™ najbezpieczniejszym wskaÅºnikiem typowej ceny transakcyjnej. W przypadku najwiÄ™kszych lokali, majÄ…cych 5 i 6 pokoi, korpusy wykresÃ³w stajÄ… siÄ™ znacznie wyÅ¼sze, co sugeruje, Å¼e w tej kategorii liczba pokoi przestaje byÄ‡ dominujÄ…cym czynnikiem cenotwÃ³rczym na rzecz standardu wykoÅ„czenia i prestiÅ¼owej lokalizacji. CaÅ‚oÅ›Ä‡ obrazuje strukturÄ™ rynkowÄ…, w ktÃ³rej ryzyko cenowe i dyspersja ofert rosnÄ… progresywnie wraz z wielkoÅ›ciÄ… nieruchomoÅ›ci, definiujÄ…c rynek o wysokim stopniu zrÃ³Å¼nicowania jakoÅ›ciowego.

</div>


```{r Typ budynku a rozkÅ‚ad cen (Violin Plot + Boxplot w Å›rodku), echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
plot3 <- apartments_final %>%
  filter(!is.na(type)) %>% 
  # Mapowanie angielskich nazw na polskie odpowiedniki
  mutate(type = recode(type, 
                       "tenement" = "Kamienica",
                       "blockOfFlats" = "Blok mieszkalny",
                       "apartmentBuilding" = "Apartamentowiec")) %>%
  ggplot(aes(x = type, y = price, fill = type)) +
  geom_violin(trim = FALSE, alpha = 0.6) +
  geom_boxplot(width = 0.15, color = "black", alpha = 0.9, outlier.shape = NA) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  scale_fill_brewer(palette = "Pastel1") + # Dodanie delikatnej palety kolorÃ³w
  labs(
    title = "Typ budynku a ceny mieszkaÅ„",
    subtitle = "PorÃ³wnanie rozkÅ‚adu cen dla rÃ³Å¼nych typÃ³w zabudowy",
    x = "Rodzaj zabudowy",
    y = "Cena (PLN)"
  ) +
  theme_minimal() +
  theme(legend.position = "none") +
  coord_flip() 

print(plot3)
```


<div class="info-box">

Analiza wykresu skrzypcowego (violin plot) wskazuje na istotne rÃ³Å¼nice w strukturze cenowej w zaleÅ¼noÅ›ci od typu zabudowy, przy czym segment apartamentowcÃ³w charakteryzuje siÄ™ najwyÅ¼szÄ… medianÄ… cen oraz najbardziej rozciÄ…gniÄ™tym prawostronnym ogonem rozkÅ‚adu. W przeciwieÅ„stwie do blokÃ³w, ktÃ³re wykazujÄ… najwiÄ™kszÄ… koncentracjÄ™ ofert w wÄ™Å¼szym przedziale cenowym i relatywnie najniÅ¼szy prÃ³g wejÅ›cia, kamienice prezentujÄ… specyficzny, dwumodalny charakter rozkÅ‚adu sugerujÄ…cy podziaÅ‚ na lokale standardowe oraz nieruchomoÅ›ci zrewitalizowane o znacznie wyÅ¼szej wartoÅ›ci. NajwiÄ™kszÄ… gÄ™stoÅ›Ä‡ prawdopodobieÅ„stwa dla wszystkich typÃ³w zabudowy obserwujemy w przedziale od 600 000 do 1 100 000 PLN, jednak to apartamentowce wykazujÄ… najszerszy rozstÄ™p miÄ™dzykwartylowy, co Å›wiadczy o najwiÄ™kszym zrÃ³Å¼nicowaniu standardu w tej kategorii. WyraÅºne wydÅ‚uÅ¼enie â€szyjekâ€ wykresÃ³w w stronÄ™ wartoÅ›ci przekraczajÄ…cych 2 mln PLN, szczegÃ³lnie widoczne w przypadku kamienic i apartamentowcÃ³w, potwierdza wystÄ™powanie silnej asymetrii dodatniej i unikalnych ofert luksusowych, ktÃ³re ksztaÅ‚tujÄ… gÃ³rnÄ… granicÄ™ badanego rynku. CaÅ‚oÅ›Ä‡ zestawienia dowodzi, Å¼e o ile blokowiska stanowiÄ… najbardziej przewidywalny i jednorodny segment cenowy, o tyle inwestycja w apartamenty lub kamienice wiÄ…Å¼e siÄ™ z wiÄ™kszÄ… dyspersjÄ… kosztÃ³w i obecnoÅ›ciÄ… ofert o charakterze wybitnie prestiÅ¼owym.

</div>

```{r Interaktywna mapa punktowa, echo=FALSE, message=FALSE, warning=FALSE, out.width="80%", fig.align="center"}
paleta <- colorNumeric(
  palette = "magma", 
  domain = apartments_final$price,
  reverse = TRUE )

mapa<-apartments_final %>%
  sample_n(min(21240, nrow(apartments_final))) %>% 
  leaflet(height = 500) %>% # Tutaj moÅ¼esz rÄ™cznie sterowaÄ‡ wysokoÅ›ciÄ… w pikselach
  addTiles() %>% 
  # WYÅšRODKOWANIE NA POLSKÄ˜:
  setView(lng = 19.145, lat = 51.919, zoom = 6) %>% 
  addCircleMarkers(
    lng = ~longitude,
    lat = ~latitude,
    radius = 4, # ZmniejszyÅ‚em odrobinÄ™ kropki, by przy mniejszej mapie byÅ‚y czytelne
    color = ~paleta(price), 
    fillOpacity = 0.8,
    stroke = FALSE,
    popup = ~paste0("<b>Cena:</b> ", format(price, big.mark = " "), " PLN"),
    label = ~as.character(price)
  ) %>%
  addLegend(
    "bottomright", 
    pal = paleta, 
    values = ~price,
    title = "Cena",
    opacity = 1
  )
mapa
```
<style>
.leaflet {
    margin-left: auto;
    margin-right: auto;
    border: 2px solid #2c3e50; 
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}
</style>

<div class="info-box">

Mapa punktowa ofert prezentuje moÅ¼liwoÅ›Ä‡ oceny koncentracji ofert w miastach wraz z rozkÅ‚adem cen w odrÃ³Å¼nienu od innych miast, ale rÃ³wnieÅ¼ dzielnic. Mapa ukazuje rÃ³Å¼nice cenowe miÄ™dzy dzielnicami centralnymi, a obrzeÅ¼ami zwanymi dzielnicami mieszkalnymi.

</div>


```{r Wykres_babelkowy_miast, echo=FALSE, message=FALSE, warning=FALSE, out.width="85%", fig.align="center"}
# Obliczamy statystyki raz
city_stats_scaled <- apartments_final %>%
  group_by(city) %>%
  summarise(
    avg_price = mean(price, na.rm = TRUE),
    avg_lat   = mean(latitude, na.rm = TRUE),
    avg_lng   = mean(longitude, na.rm = TRUE),
    offer_count = n(),
    .groups = "drop"
  ) %>%
  mutate(
    scaled_radius = scales::rescale(sqrt(offer_count), to = c(5, 35))
  )

# Definicja palety
paleta_miasta <- colorNumeric(
  palette = "viridis", 
  domain = city_stats_scaled$avg_price, 
  reverse = TRUE
)

# Renderowanie mapy - poprawione
city_stats_scaled %>%
  leaflet(height = 500) %>%
  addTiles() %>%
  setView(lng = 19.145, lat = 51.919, zoom = 6) %>% 
  addCircleMarkers(
    lng = ~avg_lng,
    lat = ~avg_lat,
    radius = ~scaled_radius, 
    fillColor = ~paleta_miasta(avg_price), # To wypeÅ‚nia Å›rodek
    fillOpacity = 0.7,
    stroke = TRUE,        # WÅ‚Ä…czamy obramowanie
    weight = 1,           # GruboÅ›Ä‡ obramowania
    color = "white",      # Kolor obramowania (to tutaj byÅ‚ bÅ‚Ä…d!)
    popup = ~paste0("<b>Miasto:</b> ", city, 
                    "<br><b>Åšrednia cena:</b> ", format(round(avg_price), big.mark = " "), " PLN",
                    "<br><b>Liczba ofert:</b> ", offer_count),
    label = ~city
  ) %>%
  addLegend(
    "bottomright", 
    pal = paleta_miasta, 
    values = ~avg_price, 
    title = "Åšrednia cena",
    labFormat = labelFormat(suffix = " PLN", big.mark = " ")
  )

```
<div class="info-box">

Mapa bÄ…belkowa uwidacznia drastyczne dysproporcje w Å›rednich cenach mieszkaÅ„, gdzie dominujÄ…ca wielkoÅ›Ä‡ i ciemny kolor bÄ…bla nad WarszawÄ… wyznacza ogÃ³lnokrajowy szczyt cenowy przekraczajÄ…cy 1 000 000 PLN. Wysoki poziom cenowy utrzymuje siÄ™ rÃ³wnieÅ¼ w aglomeracji krakowskiej i trÃ³jmiejskiej, podczas gdy mniejsze oÅ›rodki, takie jak Radom czy CzÄ™stochowa, reprezentowane sÄ… przez jasne punkty sygnalizujÄ…ce znacznie niÅ¼szy koszt zakupu nieruchomoÅ›ci. RozkÅ‚ad ten potwierdza, Å¼e kapitaÅ‚ jest silnie skoncentrowany w kilku kluczowych metropoliach, co tworzy wyraÅºny podziaÅ‚ na drogie rynki regionalne i bardziej przystÄ™pne cenowo obszary reszty kraju.

</div>

```{r Wykres sÅ‚upkowy Å›redniej ceny za mÂ² w miastach, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
apartments_final %>%
  # 1. Obliczamy cenÄ™ za metr (jeÅ›li nie ma) i grupujemy
  mutate(price_per_sqm = price / squareMeters) %>%
  group_by(city) %>%
  summarise(mean_price_sqm = mean(price_per_sqm, na.rm = TRUE)) %>%
  
  # 2. Rysujemy
  # reorder() sortuje miasta od najtaÅ„szego do najdroÅ¼szego - kluczowe dla czytelnoÅ›ci
  ggplot(aes(x = reorder(city, mean_price_sqm), y = mean_price_sqm)) +
  
  # geom_col() to funkcja do sÅ‚upkÃ³w, gdy mamy wyliczone wartoÅ›ci
  geom_col(fill = "steelblue") + 
  
  # Obracamy wykres, Å¼eby nazwy miast siÄ™ czytaÅ‚o normalnie
  coord_flip() +
  
  # Opisy i formatowanie
  labs(
    title = "Åšrednia cena za mÂ² w miastach",
    x = "Miasto",
    y = "Cena za mÂ² (PLN)"
  ) +
  theme_minimal()
```

<div class="info-box">

Wykres sÅ‚upkowy prezentuje wyraÅºnÄ… hierarchiÄ™ cenowÄ… polskich miast, w ktÃ³rej Warszawa deklasuje pozostaÅ‚e oÅ›rodki z rekordowÄ… Å›redniÄ… stawkÄ… przekraczajÄ…cÄ… 18 000 PLN za mÂ². Drugi segment rynku tworzÄ… KrakÃ³w oraz GdaÅ„sk, gdzie ceny oscylujÄ… w granicach 15 000 â€“ 17 000 PLN, podczas gdy na przeciwlegÅ‚ym biegunie znajdujÄ… siÄ™ Radom i CzÄ™stochowa z ofertami poniÅ¼ej 7 500 PLN za mÂ². Tak duÅ¼a rozpiÄ™toÅ›Ä‡ â€” siÄ™gajÄ…ca ponad 150% miÄ™dzy stolicÄ… a miastami o najniÅ¼szych stawkach â€” obrazuje gÅ‚Ä™bokie rozwarstwienie ekonomiczne kraju i koncentracjÄ™ popytu inwestycyjnego w kilku kluczowych metropoliach.

</div>

```{r Wykres zaleÅ¼noÅ›ci ceny od odlegÅ‚oÅ›ci - UjÄ™cie ogÃ³lnokrajowe, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
wykres_odleglosci_polska <- apartments_final %>%
  mutate(cena_za_m2 = price / squareMeters) %>%
  # Filtracja outlierÃ³w dla lepszej czytelnoÅ›ci trendu
  filter(cena_za_m2 < 60000, centreDistance <= 30) %>% 
  ggplot(aes(x = centreDistance, y = cena_za_m2)) +
  # ZagÄ™szczenie punktÃ³w (hexbin lub maÅ‚e punkty z duÅ¼ym alpha)
  geom_point(alpha = 0.1, color = "#2c3e50", size = 0.8) +
  # Linia trendu dla caÅ‚ej Polski
  geom_smooth(method = "gam", color = "#e74c3c", size = 1.5, se = TRUE) +
  scale_y_continuous(labels = scales::label_number(suffix = " PLN", big.mark = " ")) +
  labs(
    title = "Krajowa zaleÅ¼noÅ›Ä‡ ceny od dystansu do centrum",
    subtitle = "ZbiÃ³r wszystkich ofert z uwzglÄ™dnieniem linii trendu GAM",
    x = "OdlegÅ‚oÅ›Ä‡ od centrum (km)",
    y = "Cena za mÂ² (PLN)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(face = "bold", size = 16),
    panel.grid.minor = element_blank()
  )

print(wykres_odleglosci_polska)
```

<div class="info-box">
Wykres rozrzutu z liniÄ… trendu GAM obrazuje zÅ‚oÅ¼onÄ… zaleÅ¼noÅ›Ä‡ ceny za mÂ² od odlegÅ‚oÅ›ci lokalu od centrum, podwaÅ¼ajÄ…c prosty schemat liniowego spadku wartoÅ›ci wraz z oddalaniem siÄ™ od rdzenia miasta. ChoÄ‡ najwyÅ¼sze stawki jednostkowe, przekraczajÄ…ce 25 000 PLN, koncentrujÄ… siÄ™ w bezpoÅ›rednim sÄ…siedztwie centrum (0â€“2 km), linia trendu wykazuje charakterystyczne falowanie, z lokalnym wzrostem cen w okolicach 10. kilometra, co sugeruje wysokÄ… wycenÄ™ prestiÅ¼owych dzielnic sypialnianych oraz nowoczesnych osiedli apartamentowych na obrzeÅ¼ach metropolii. Ogromna chmura punktÃ³w poniÅ¼ej 15 000 PLN, rozciÄ…gajÄ…ca siÄ™ jednostajnie wzdÅ‚uÅ¼ caÅ‚ej osi odlegÅ‚oÅ›ci, Å›wiadczy o szerokiej dostÄ™pnoÅ›ci lokali o niÅ¼szym standardzie niezaleÅ¼nie od lokalizacji, podczas gdy wyraÅºne zwÄ™Å¼enie rozkÅ‚adu powyÅ¼ej 15 km sygnalizuje ostateczny spadek stawek na terenach podmiejskich. W efekcie wykres dowodzi, Å¼e o ile Å›cisÅ‚e centrum generuje rekordowe ceny ofertowe, o tyle wtÃ³rne rynki lokalne i segmenty premium poza centrum skutecznie stabilizujÄ… Å›redniÄ… cenÄ™ za metr kwadratowy na poziomie okoÅ‚o 15 000 PLN dla wiÄ™kszoÅ›ci badanego obszaru.

</div>

```{r Wykres hexbin pokazujÄ…cy zaleÅ¼noÅ›Ä‡ ceny za m2 od liczby punktÃ³w POI, wygÅ‚adzony trend GAM, skala logarytmiczna, echo=FALSE, fig.height=8, fig.width=16, message=FALSE, warning=FALSE}
wykres_fajerwerki <- apartments_final %>%
  mutate(price_per_sqm = price / squareMeters) %>%
  # Filtracja ceny i uciÄ™cie pustego "ogona" POI dla lepszej czytelnoÅ›ci
  filter(price_per_sqm < 70000, poiCount <= 180) %>%  
  
  ggplot(aes(x = poiCount, y = price_per_sqm)) +
  
  geom_hex(bins = 70) +
  
  # 1. Logarytmowanie osi Y
  scale_y_log10(breaks = c(5000, 10000, 15000, 20000, 30000, 50000)) +
  
  scale_fill_viridis_c(option = "plasma", name = "Liczba\nofert") +
  
  # 2. WygÅ‚adzenie linii trendu (ograniczenie liczby wÄ™zÅ‚Ã³w k=5 zapobiega "wÄ™Å¼ykowi")
  geom_smooth(method = "gam", formula = y ~ s(x, k = 5), 
              color = "cyan", fill = "white", alpha = 0.2, size = 1.5) +
  
  labs(
    title = "WpÅ‚yw punktÃ³w usÅ‚ugowych (POI) na cenÄ™ metra kwadratowego",
    subtitle = "Skala logarytmiczna i wygÅ‚adzony trend GAM (dane do 180 POI)",
    x = "Liczba punktÃ³w POI w zasiÄ™gu (poiCount)",
    y = "Cena za mÂ² (PLN, skala log)"
  ) +
  
  theme_dark() +
  theme(
    plot.title = element_text(size = 16, face = "bold", color = "white"),
    plot.subtitle = element_text(color = "#cccccc"),
    axis.text = element_text(color = "#eeeeee"),
    axis.title = element_text(color = "white"),
    legend.background = element_rect(fill = "#333333"),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    plot.background = element_rect(fill = "#222222"), 
    panel.grid.major = element_line(color = "#444444"), 
    panel.grid.minor = element_blank()
  )

wykres_fajerwerki
```

<div class="info-box">

Wykres przedstawiajÄ…cy wpÅ‚yw liczby punktÃ³w usÅ‚ugowych (POI) na cenÄ™ metra kwadratowego wykazuje wyraÅºnÄ…, nieliniowÄ… zaleÅ¼noÅ›Ä‡ wzrostowÄ…, w ktÃ³rej bogatsza infrastruktura otoczenia bezpoÅ›rednio przekÅ‚ada siÄ™ na wyÅ¼szÄ… wycenÄ™ nieruchomoÅ›ci. Linia trendu GAM sugeruje, Å¼e najwiÄ™kszy przyrost wartoÅ›ci nastÄ™puje w przedziale od 50 do 130 punktÃ³w usÅ‚ugowych, gdzie cena za mÂ² stabilizuje siÄ™ na poziomie powyÅ¼ej 20 000 PLN, co odzwierciedla rynkowÄ… premiÄ™ za komfort Å¼ycia w peÅ‚ni zurbanizowanych dzielnicach. NajwiÄ™ksza koncentracja ofert (Å¼Ã³Å‚te i pomaraÅ„czowe pola) wystÄ™puje przy niskiej liczbie punktÃ³w POI i cenach rzÄ™du 10 000 â€“ 15 000 PLN, natomiast spadek linii trendu powyÅ¼ej 150 punktÃ³w usÅ‚ugowych moÅ¼e sygnalizowaÄ‡ nasycenie lub specyfikÄ™ bardzo gÄ™stych centrÃ³w miast, gdzie haÅ‚as i brak prywatnoÅ›ci zaczynajÄ… ograniczaÄ‡ dalszy wzrost stawek.

</div>

```{r Heatmapa V Cramera, echo=FALSE, fig.height=16, fig.width=16, message=FALSE, warning=FALSE}
# 1. Biblioteki
library(ggplot2)
library(reshape2)
library(dplyr)

# 2. Przygotowanie danych i wybÃ³r kolumn numerycznych
data_corr <- apartments_final %>%
  # Tworzymy nowÄ… zmiennÄ…: cena za metr kwadratowy
  mutate(price_per_sqm = price / squareMeters) %>%
  # Wybieramy zmienne
  select(price_per_sqm, squareMeters, rooms, centreDistance, poiCount, buildYear) %>%
  # ZMIANA NAZW NA POLSKIE
  rename(
    "Cena za mÂ²" = price_per_sqm,
    "MetraÅ¼" = squareMeters,
    "Liczba pokoi" = rooms,
    "Dystans do centrum" = centreDistance,
    "Liczba POI" = poiCount,
    "Rok budowy" = buildYear
  ) %>%
  na.omit()

# 3. Obliczenie macierzy korelacji Pearsona
corr_matrix <- cor(data_corr, method = "pearson")

# 4. Przygotowanie do wykresu (trÃ³jkÄ…tna mapa)
corr_matrix[upper.tri(corr_matrix)] <- NA
melted_corr <- melt(corr_matrix, na.rm = TRUE)

# 5. Wizualizacja
ggplot(melted_corr, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  # Dodanie wartoÅ›ci korelacji na kafelkach
  geom_text(aes(label = round(value, 2)), size = 4, fontface = "bold") +
  # Skala kolorÃ³w: czerwony (ujemna), biaÅ‚y (zero), niebieski (dodatnia)
  scale_fill_gradient2(low = "#e74c3c", high = "#3498db", mid = "white", 
                       midpoint = 0, limit = c(-1, 1), 
                       name = "Korelacja\nPearsona") +
  theme_minimal() +
  labs(title = "Co wpÅ‚ywa na cenÄ™ za mÂ² mieszkania?",
       subtitle = "Korelacja Pearsona dla zmiennych numerycznych",
       x = NULL, y = NULL) +
  theme(
    axis.text = element_text(size = 10, face = "bold"),
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    panel.grid = element_blank()
  ) +
  coord_fixed()
```

<div class="info-box">

Macierz korelacji Pearsona wskazuje na zrÃ³Å¼nicowany wpÅ‚yw poszczegÃ³lnych zmiennych na cenÄ™ za mÂ², przy czym najsilniejszym dodatnim czynnikiem powiÄ…zanym z wartoÅ›ciÄ… jednostkowÄ… nieruchomoÅ›ci jest liczba punktÃ³w usÅ‚ugowych (POI) w zasiÄ™gu, co potwierdza wysokÄ… rynkowÄ… wycenÄ™ infrastruktury miejskiej. Co ciekawe, metraÅ¼ oraz liczba pokoi wykazujÄ… sÅ‚abÄ… korelacjÄ™ ujemnÄ… z cenÄ… za mÂ², co sugeruje, Å¼e wraz ze wzrostem caÅ‚kowitej powierzchni mieszkania, stawka za pojedynczy metr kwadratowy ma tendencjÄ™ do lekkiego spadku. JednoczeÅ›nie obserwujemy silne, naturalne wspÃ³Å‚zaleÅ¼noÅ›ci miÄ™dzy metraÅ¼em a liczbÄ… pokoi (0.82) oraz istotnÄ… korelacjÄ™ ujemnÄ… miÄ™dzy dystansem do centrum a liczbÄ… punktÃ³w POI (-0.45), co dowodzi, Å¼e im dalej od serca miasta, tym uboÅ¼sza staje siÄ™ oferta usÅ‚ugowa, co poÅ›rednio rzutuje na finalnÄ… wycenÄ™ lokalu.

</div>
```{r Interaktywny_Dashboard_RPubs_Clean, echo=FALSE, message=FALSE, warning=FALSE}

library(crosstalk)
library(plotly)
library(dplyr)
library(htmltools)


dane_do_widgetu <- apartments_final %>%
  select(city, price, squareMeters, buildYear, centreDistance, hasElevator) %>%
  mutate(hasElevator = ifelse(hasElevator == "yes", "Tak", "Nie"))

sd <- SharedData$new(dane_do_widgetu)


bscols(
  widths = c(3, 9), # Lewa kolumna (3), Prawa kolumna (9)
  
 
  list(
    h4("ğŸ›ï¸ Filtry"),
    
    # Suwak dystansu
    filter_slider("dist", "OdlegÅ‚oÅ›Ä‡ od centrum (km)", sd, ~centreDistance, step = 0.5, width = "100%"),
    
    # Suwak metraÅ¼u
    filter_slider("sqm", "MetraÅ¼ (mÂ²)", sd, ~squareMeters, step = 1, width = "100%"),
    
    # Checkbox windy
    filter_checkbox("elevator", "Winda", sd, ~hasElevator)
  ), 
 
  
 
  list(
    plot_ly(sd, x = ~price, type = "histogram", marker = list(color = "#2c3e50")) %>%
      layout(
        title = "RozkÅ‚ad cen w wybranym segmencie",
        xaxis = list(title = "Cena (PLN)"),
        yaxis = list(title = "Liczba ofert"),
        bargap = 0.1
      )
  )
)
```
<div class="info-box">
PowyÅ¼szy moduÅ‚ umoÅ¼liwia dynamicznÄ… segmentacjÄ™ rynku. ManipulujÄ…c suwakami, moÅ¼na zaobserwowaÄ‡ zjawisko elastycznoÅ›ci cenowej: przy zmniejszaniu odlegÅ‚oÅ›ci od centrum (< 3 km), histogram wyraÅºnie przesuwa siÄ™ w prawo i spÅ‚aszcza, co potwierdza wystÄ™powanie znacznej premii lokalizacyjnej oraz wiÄ™ksze rozwarstwienie cen w prestiÅ¼owych dzielnicach.
</div>
```{r Podstawowe statystyki opisowe w podziale na miasta, echo=FALSE, fig.height=16, fig.width=16, message=FALSE, warning=FALSE}

if (!require("e1071")) install.packages("e1071")
if (!require("DT")) install.packages("DT")
library(e1071)
library(dplyr)
library(tidyr)
library(DT)


tabela_stylizowana <- apartments_final %>%
  group_by(city) %>%
  summarise(
    Min = min(price, na.rm = TRUE),
    Max = max(price, na.rm = TRUE),
    `Kwartyl dolny` = quantile(price, 0.25, na.rm = TRUE),
    Mediana = median(price, na.rm = TRUE),
    `Kwartyl gÃ³rny` = quantile(price, 0.75, na.rm = TRUE),
    Åšrednia = mean(price, na.rm = TRUE),
    `Odch. std.` = sd(price, na.rm = TRUE),
    IQR = IQR(price, na.rm = TRUE),
    `Odchylenie Ä‡wiartkowe` = IQR(price, na.rm = TRUE) / 2,
    `Odch. std. w %` = (sd(price, na.rm = TRUE) / mean(price, na.rm = TRUE)),
    `Odch. Ä‡wiartkowe w %` = (IQR(price, na.rm = TRUE) / 2) / median(price, na.rm = TRUE),
    SkoÅ›noÅ›Ä‡ = skewness(price, na.rm = TRUE),
    Kurtoza = kurtosis(price, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = -city, names_to = "Statystyka", values_to = "WartoÅ›Ä‡") %>%
  pivot_wider(names_from = city, values_from = WartoÅ›Ä‡) %>%
  mutate(across(where(is.numeric), ~ round(., 2)))


datatable(tabela_stylizowana,
          extensions = 'FixedColumns', 
          options = list(
            pageLength = 15,
            scrollX = TRUE,      
            dom = 't',
            fixedColumns = list(leftColumns = 1) # <--- KROK 2: Przypinamy 1. kolumnÄ™
          ),
          class = 'cell-border stripe',
          rownames = FALSE,
          caption = 'PorÃ³wnanie Statystyk Cenowych Miast (PrzewiÅ„ w prawo ->)')
```
<div class="info-box">

</div>

```{r Statystyki opisowe w relacji, type a cena za metr kwadratowy, echo=FALSE, fig.height=16, fig.width=16, message=FALSE, warning=FALSE}
# 1. Instalacja i Å‚adowanie niezbÄ™dnych bibliotek
if (!require("e1071")) install.packages("e1071")
if (!require("DT")) install.packages("DT")
library(e1071)
library(dplyr)
library(tidyr)
library(DT)

# 2. Przygotowanie statystyk i zmiana nazw na polskie w jednym kroku
tabela_polskie_nazwy <- apartments_final %>%
  mutate(price_per_sqm = price / squareMeters) %>%
  filter(!is.na(type)) %>%
  # Tutaj zmieniamy nazwy wartoÅ›ci w kolumnie 'type' zanim jÄ… obrÃ³cimy
  mutate(type = case_when(
    type == "apartmentBuilding" ~ "Apartamentowiec",
    type == "blockOfFlats" ~ "Blok",
    type == "tenement" ~ "Kamienica",
    TRUE ~ type
  )) %>%
  group_by(type) %>%
  summarise(
    Min = min(price_per_sqm, na.rm = TRUE),
    Max = max(price_per_sqm, na.rm = TRUE),
    `Kwartyl dolny` = quantile(price_per_sqm, 0.25, na.rm = TRUE),
    Mediana = median(price_per_sqm, na.rm = TRUE),
    `Kwartyl gÃ³rny` = quantile(price_per_sqm, 0.75, na.rm = TRUE),
    Åšrednia = mean(price_per_sqm, na.rm = TRUE),
    `Odch. std.` = sd(price_per_sqm, na.rm = TRUE),
    IQR = IQR(price_per_sqm, na.rm = TRUE),
    `Odchylenie Ä‡wiartkowe` = IQR(price_per_sqm, na.rm = TRUE) / 2,
    `Odch. std. w %` = (sd(price_per_sqm, na.rm = TRUE) / mean(price_per_sqm, na.rm = TRUE)),
    `Odch. Ä‡wiartkowe w %` = (IQR(price_per_sqm, na.rm = TRUE) / 2) / median(price_per_sqm, na.rm = TRUE),
    SkoÅ›noÅ›Ä‡ = skewness(price_per_sqm, na.rm = TRUE),
    Kurtoza = kurtosis(price_per_sqm, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  # 2. Transpozycja (teraz type ma juÅ¼ polskie nazwy, wiÄ™c pivot_wider zrobi polskie kolumny)
  pivot_longer(cols = -type, names_to = "Statystyka", values_to = "WartoÅ›Ä‡") %>%
  pivot_wider(names_from = type, values_from = WartoÅ›Ä‡) %>%
  mutate(across(where(is.numeric), ~ round(., 2)))

# 3. WyÅ›wietlenie tabeli
datatable(tabela_polskie_nazwy, 
          options = list(
            pageLength = 15, 
            dom = 't',          
            scrollX = TRUE,     
            ordering = FALSE    
          ),
          class = 'cell-border stripe', 
          rownames = FALSE,
          caption = 'Statystyki opisowe ceny za mÂ² w zaleÅ¼noÅ›ci od typu zabudowy')

```

<div class="info-box">

</div>
## 3.2 Analiza rÃ³Å¼nic cenowych miÄ™dzy WarszawÄ… a GdaÅ„skiem
<div class="info-box">
W niniejszym podrozdziale zestawiono dwa duÅ¼e rynki w Polsce: **stoÅ‚ecznÄ… WarszawÄ™**, bÄ™dÄ…cÄ… centrum biznesowym, oraz **GdaÅ„sk**, peÅ‚niÄ…cy rolÄ™ kluczowego oÅ›rodka turystycznego i portowego. BezpoÅ›rednia analiza porÃ³wnawcza pozwala oszacowaÄ‡ "premiÄ™ stoÅ‚ecznÄ…" oraz zweryfikowaÄ‡, w jakim stopniu segmenty cenowe obu aglomeracji siÄ™ pokrywajÄ…. Zbadanie rÃ³Å¼nic w rozkÅ‚adach cen jest kluczowe dla oceny, czy gdaÅ„ski rynek premium stanowi cenowÄ… alternatywÄ™ dla standardowych inwestycji w stolicy.
</div>
```{r warszawa_vs_gdansk, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
apartments_final %>%
  filter(city %in% c("warszawa", "gdansk")) %>%
  filter(price < 2500000) %>% # Ocinamy ekstremalne ogony dla czytelnoÅ›ci
  ggplot(aes(x = price, fill = city)) +
  geom_density(alpha = 0.6, color = NA) +
  scale_x_continuous(labels = scales::label_number(suffix = " PLN", scale = 1e-6, accuracy = 0.1, big.mark = ",")) +
  scale_fill_manual(values = c("gdansk" = "#2980b9", "warszawa" = "#c0392b")) +
  labs(
    title = "Warszawa vs GdaÅ„sk",
    subtitle = "RozkÅ‚ad gÄ™stoÅ›ci cen ofertowych (oÅ› X w mln PLN)",
    x = "Cena caÅ‚kowita (mln PLN)",
    y = "GÄ™stoÅ›Ä‡ rozkÅ‚adu",
    fill = "Miasto"
  ) +
  theme_minimal(base_family = "sans") +
  theme(
    legend.position = "top",
    plot.title = element_text(face = "bold", size = 14, color = "#2c3e50")
  )
```
<div class="info-box">
Analiza wizualna ujawnia fundamentalne rÃ³Å¼nice w strukturze obu rynkÃ³w. GdaÅ„sk (kolor niebieski) charakteryzuje siÄ™ rozkÅ‚adem leptokurtycznym (smukÅ‚ym) â€“ oznacza to wysokÄ… koncentracjÄ™ ofert w wÄ…skim przedziale cenowym (ok. 600-700 tys. PLN). Rynek ten jest bardziej jednorodny i przewidywalny dla inwestora.

Z kolei Warszawa (kolor czerwony) prezentuje rozkÅ‚ad spÅ‚aszczony z wyraÅºnym przesuniÄ™ciem w stronÄ™ wyÅ¼szych wartoÅ›ci (mediana ok. 850 tys. PLN). KluczowÄ… obserwacjÄ… jest tzw. "gruby ogon" (fat tail) po prawej stronie wykresu. Wskazuje on na znaczÄ…cy udziaÅ‚ segmentu luksusowego w stolicy â€“ oferty powyÅ¼ej 1,5 mln PLN stanowiÄ… tu istotnÄ… czÄ™Å›Ä‡ rynku, podczas gdy w GdaÅ„sku sÄ… zjawiskiem marginalnym. StoÅ‚eczny rynek cechuje siÄ™ wiÄ™c znacznie wiÄ™kszÄ… dyspersjÄ… (zrÃ³Å¼nicowaniem) cenowym
</div>
```{r Wykres_odleglosci_WWA_GDA, echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12}
wykres_odleglosci <- apartments_final %>%
  mutate(price_per_sqm = price / squareMeters) %>%
  
  # --- TUTAJ JEST ZMIANA ---
  # Zostawiamy tylko te dwa miasta:
  filter(city %in% c("warszawa", "gdansk")) %>%
  
  # Wywalamy bÅ‚Ä™dy cenowe (outliery)
  filter(price_per_sqm < 60000) %>%
  
  # Dodalem 'color = city', zeby sie roznily kolorami
  ggplot(aes(x = centreDistance, y = price_per_sqm, color = city)) +
  
  # Punkty troche mniejsze i bardziej przezroczyste, zeby bylo widac zageszczenie
  geom_point(alpha = 0.3, size = 1.2) +
  
  # Linia trendu
  geom_smooth(method = "gam", color = "black", se = FALSE, size = 1) + 
  
  # PodziaÅ‚ na dwa panele obok siebie
  facet_wrap(~city, scales = "free") +
  
  # Kolorki (Warszawa na czerwono, Gdansk na niebiesko - klasyk)
  scale_color_manual(values = c("ddansk" = "#2980b9", "warszawa" = "#c0392b")) +
  
  labs(
    title = "Czy im dalej od centrum, tym taniej?",
    subtitle = "PorÃ³wnanie trendÃ³w: GdaÅ„sk vs Warszawa",
    x = "OdlegÅ‚oÅ›Ä‡ od centrum (km)",
    y = "Cena za mÂ² (PLN)"
  ) +
  theme_minimal() +
  theme(
    legend.position = "none", # Legenda niepotrzebna, bo mamy podpisy nad wykresami
    strip.text = element_text(size = 14, face = "bold") # Wieksze nazwy miast
  )

wykres_odleglosci
```
<div class="info-box">
Interpretacja trendÃ³w lokalizacyjnych:

Zestawienie ujawnia fundamentalnÄ… rÃ³Å¼nicÄ™ w strukturze przestrzennej obu aglomeracji:

Warszawa (Model Monocentryczny): Wykres po prawej stronie prezentuje klasycznÄ…, ujemnÄ… korelacjÄ™ liniowÄ…. NajwyÅ¼sze ceny (>25 tys. PLN/mÂ²) koncentrujÄ… siÄ™ w Å›cisÅ‚ym centrum (0-2 km). Wraz ze wzrostem dystansu, cena spada w sposÃ³b niemal jednostajny. Jest to podrÄ™cznikowy przykÅ‚ad "renty lokalizacyjnej" â€“ im bliÅ¼ej PaÅ‚acu Kultury i Nauki, tym droÅ¼ej.

GdaÅ„sk (Model Pasmowy / Policentryczny): Wykres po lewej jest znacznie bardziej zÅ‚oÅ¼ony i przypomina ksztaÅ‚tem literÄ™ "W".

0-2 km (Stare Miasto): Wysokie ceny wynikajÄ… z walorÃ³w turystycznych i historycznych (najem krÃ³tkoterminowy).

3-4 km (Lokalne Minimum): Spadek cen w dzielnicach przejÅ›ciowych (np. Siedlce, CheÅ‚m), ktÃ³re sÄ… blisko centrum historycznego, ale nie posiadajÄ… jego prestiÅ¼u.

5-9 km (Drugi Szczyt Cenowy): Krzywa ponownie roÅ›nie. Jest to efekt unikalnej struktury "Centralnego Pasma UsÅ‚ugowego" (Wrzeszcz, Oliwa â€“ bÄ™dÄ…ce faktycznym centrum biznesowym aglomeracji) oraz Pasa Nadmorskiego (Przymorze, Å»abianka, Jelitkowo). W GdaÅ„sku "centrum" nie jest punktem, lecz osiÄ… komunikacyjnÄ… biegnÄ…cÄ… wzdÅ‚uÅ¼ linii SKM, co sprawia, Å¼e lokale poÅ‚oÅ¼one nawet 8-9 km od historycznego ÅšrÃ³dmieÅ›cia osiÄ…gajÄ… wyceny zbliÅ¼one do tych ze starÃ³wki.
</div>



```{r Mapa_Hex_Patchwork, echo=FALSE, message=FALSE, warning=FALSE, fig.height=7, fig.width=14, fig.align="center"}
# Instalujemy/Å‚adujemy bibliotekÄ™ do Å‚Ä…czenia wykresÃ³w
if (!require("patchwork")) install.packages("patchwork")
library(patchwork)
library(ggplot2)
library(dplyr)
library(hexbin)
library(viridis)
library(osmdata)
library(sf)

# --- 1. PRZYGOTOWANIE DANYCH ---
static_data <- apartments_final %>%
  mutate(city_norm = tolower(city)) %>%
  filter(city_norm %in% c("gdansk", "gdaÅ„sk", "warszawa")) %>%
  mutate(city = if_else(grepl("gdansk|gdaÅ„sk", city_norm), "GdaÅ„sk", "Warszawa")) %>%
  mutate(buildYear = as.numeric(as.character(buildYear))) %>%
  filter(!is.na(buildYear), buildYear >= 1900, buildYear <= 2026) %>%
  filter(!is.na(latitude), !is.na(longitude))

# --- 2. POBIERANIE GRANIC ---
pobierz_granice <- function(miasto_osm) {
  tryCatch({
    granica <- opq(bbox = miasto_osm, timeout = 60) %>% 
      add_osm_feature(key = "admin_level", value = "8") %>% 
      osmdata_sf()
    granica$osm_multipolygons %>% filter(name == miasto_osm)
  }, error = function(e) return(NULL))
}

granica_gda <- NULL
granica_wwa <- NULL
try({
  granica_gda <- pobierz_granice("GdaÅ„sk")
  granica_wwa <- pobierz_granice("Warszawa")
}, silent = TRUE)

# --- 3. FUNKCJA RYSUJÄ„CA JEDNO MIASTO ---
rysuj_miasto <- function(dane, granice, nazwa_miasta) {
  
  # Filtrujemy dane dla konkretnego miasta
  dane_miasta <- dane %>% filter(city == nazwa_miasta)
  
  ggplot() +
    # TÅ‚o (czarne)
    geom_rect(aes(xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf), fill = "#101010") +
    
    # Granice (jeÅ›li sÄ…)
    {if (!is.null(granice)) geom_sf(data = granice, fill = "#1a1a1a", color = "#555555", size = 0.8)} +
    
    # Hexbiny
    stat_summary_hex(
      data = dane_miasta,
      aes(x = longitude, y = latitude, z = buildYear),
      fun = median, 
      bins = 40, # Mniej binÃ³w bo wykresy bÄ™dÄ… mniejsze
      color = "black", 
      size = 0.1
    ) +
    
    # Skala kolorÃ³w
    scale_fill_viridis_c(
      option = "magma", 
      limits = c(1950, 2024), # Sztywna skala, Å¼eby kolory znaczyÅ‚y to samo na obu mapach!
      oob = scales::squish,   # Jak coÅ› jest starsze niÅ¼ 1950, traktuj jak 1950
      name = "Rok budowy"
    ) +
    
    labs(title = nazwa_miasta) +
    theme_void() +
    theme(
      plot.background = element_rect(fill = "#101010", color = NA),
      panel.background = element_rect(fill = "#101010", color = NA),
      text = element_text(color = "white"),
      plot.title = element_text(size = 22, face = "bold", hjust = 0.5, margin = margin(b = 10)),
      legend.position = "none" # LegendÄ™ dodamy osobno na koÅ„cu
    )
}

# --- 4. TWORZENIE DWÃ“CH WYKRESÃ“W ---
p_gda <- rysuj_miasto(static_data, granica_gda, "GdaÅ„sk")
p_wwa <- rysuj_miasto(static_data, granica_wwa, "Warszawa")

# --- 5. ÅÄ„CZENIE (MAGIA PATCHWORK) ---
# SkÅ‚adamy dwa wykresy obok siebie i dodajemy wspÃ³lnÄ… legendÄ™
final_plot <- (p_gda + p_wwa) +
  plot_layout(guides = "collect") & # WspÃ³lna legenda
  theme(
    legend.position = "bottom",
    legend.background = element_rect(fill = "#101010"),
    legend.text = element_text(color = "white"),
    legend.title = element_text(color = "white"),
    legend.key.width = unit(2, "cm")
  )

# Dodajemy nagÅ‚Ã³wek do caÅ‚oÅ›ci
final_plot + plot_annotation(
  title = "Gdzie buduje siÄ™ nowe?",
  subtitle = "Analiza przestrzenna wieku tkanki miejskiej (Mediana roku budowy)",
  caption = "Szary kontur = granice miasta | Kolorowe punkty = oferty sprzedaÅ¼y",
  theme = theme(
    plot.background = element_rect(fill = "#101010", color = NA),
    plot.title = element_text(size = 26, face = "bold", color = "white", hjust = 0.5),
    plot.subtitle = element_text(size = 16, color = "#cccccc", hjust = 0.5),
    plot.caption = element_text(size = 12, color = "#888888")
  )
)
```
<div class="info-box">
Analiza Przestrzenna Struktury Wieku Tkanki Miejskiej 

PowyÅ¼sza wizualizacja wykorzystuje agregacjÄ™ heksagonalnÄ… do zbadania rozkÅ‚adu przestrzennego inwestycji mieszkaniowych. Zastosowanie mediany roku budowy jako zmiennej koloryzujÄ…cej pozwala na zniwelowanie wpÅ‚ywu pojedynczych nowych inwestycji w starszych dzielnicach (tzw. plomby) i uwypuklenie dominujÄ…cego charakteru zabudowy w danym rejonie.

Analiza ujawnia dwa odmienne modele rozwoju aglomeracji:

Warszawa (Model Monocentryczny â€“ "Efekt Obwarzanka"):

RdzeÅ„ (Core): Centrum miasta oraz dzielnice oÅ›cienne (MokotÃ³w, Ochota, Å»oliborz) charakteryzujÄ… siÄ™ dominacjÄ… barw ciemnych (fiolet), co odpowiada starszej tkance historycznej oraz zabudowie z okresu PRL (wielka pÅ‚yta).

Peryferia: Obserwujemy wyraÅºny, jasny pierÅ›cieÅ„ okalajÄ…cy miasto. Jest to dowÃ³d na silnÄ… suburbanizacjÄ™ i zjawisko urban sprawl. Najnowsze inwestycje (jasnoÅ¼Ã³Å‚te klastry, mediana > 2015 r.) sÄ… wypychane na obrzeÅ¼a (BiaÅ‚oÅ‚Ä™ka, Ursus, WilanÃ³w), gdzie dostÄ™pnoÅ›Ä‡ gruntÃ³w jest wiÄ™ksza, a ich ceny niÅ¼sze.

GdaÅ„sk (Model Pasmowy / Linearny):

Struktura wieku zabudowy jest skorelowana z gÅ‚Ã³wnÄ… osiÄ… komunikacyjnÄ… (SKM / Al. Grunwaldzka). Starsza zabudowa (fiolet) ciÄ…gnie siÄ™ wzdÅ‚uÅ¼ tego pasma oraz w historycznym ÅšrÃ³dmieÅ›ciu.

Ekspansja PoÅ‚udniowa: W przeciwieÅ„stwie do warszawskiego "pierÅ›cienia", w GdaÅ„sku widzimy silnÄ… koncentracjÄ™ nowych inwestycji (jasne plamy) w jednym, konkretnym kierunku â€“ na poÅ‚udnie od obwodnicy (GdaÅ„sk PoÅ‚udnie, JasieÅ„), tworzÄ…c rozlegÅ‚e, nowoczesne dzielnice sypialniane.

Wniosek: Mapa potwierdza, Å¼e w Warszawie "nowe" oznacza "daleko od centrum", podczas gdy w GdaÅ„sku nowe inwestycje intensywnie wypeÅ‚niajÄ… luki w tkance miejskiej (pas nadmorski) oraz tworzÄ… nowe centrum sypialniane na poÅ‚udniu.
</div>
```{r Statystyki_WWA_GDA_Pokoje, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(DT)
library(e1071)
tabela_pokoje <- apartments_final %>%
  filter(city %in% c("warszawa", "gdansk")) %>%
  filter(rooms >= 1 & rooms <= 4) %>% 
  mutate(Kategoria = paste0(city, " (", rooms, " p.)")) %>% 
  group_by(Kategoria) %>%
  summarise(
    Min = min(price, na.rm = TRUE),
    `Kwartyl dolny` = quantile(price, 0.25, na.rm = TRUE),
    Mediana = median(price, na.rm = TRUE),
    `Kwartyl gÃ³rny` = quantile(price, 0.75, na.rm = TRUE),
    Max = max(price, na.rm = TRUE),
    Åšrednia = mean(price, na.rm = TRUE),
    `Odch. std.` = sd(price, na.rm = TRUE),
    IQR = IQR(price, na.rm = TRUE),
    `SkoÅ›noÅ›Ä‡` = skewness(price, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  pivot_longer(cols = -Kategoria, names_to = "Statystyka", values_to = "WartoÅ›Ä‡") %>%
  pivot_wider(names_from = Kategoria, values_from = WartoÅ›Ä‡) %>%
  mutate(across(where(is.numeric), ~ round(., 2)))


kolumny_dane <- sort(names(tabela_pokoje)[-1])
tabela_pokoje <- tabela_pokoje %>% select("Statystyka", all_of(kolumny_dane))


cols_gdansk <- grep("gdansk", names(tabela_pokoje), value = TRUE)
cols_wawa   <- grep("warszawa", names(tabela_pokoje), value = TRUE)


datatable(tabela_pokoje,
          extensions = 'FixedColumns', 
          options = list(
            pageLength = 15,
            scrollX = TRUE,      
            dom = 't',
            fixedColumns = list(leftColumns = 1) 
          ),
          class = 'cell-border hover',
          rownames = FALSE,
          caption = 'SzczegÃ³Å‚owa analiza cen: PodziaÅ‚ na pokoje (GdaÅ„sk vs Warszawa)') %>%
  

  formatStyle(
    columns = cols_gdansk,
    backgroundColor = styleInterval(c(0), c('#eaf2f8', '#d4e6f1')), 
    color = '#154360',
    fontWeight = 'bold'
  ) %>%
  

  formatStyle(
    columns = cols_wawa,
    backgroundColor = styleInterval(c(0), c('#fdedec', '#fadbd8')), 
    color = '#78281f',
    fontWeight = 'bold'
  ) %>%
  
  
  formatCurrency(
    columns = names(tabela_pokoje)[-1], 
    currency = "", 
    interval = 3, 
    mark = " ", 
    digits = 0
  )
```
<div class="info-box">
</div>
## 3.3 Testy statystyczne

# 4.Podsumowanie







